<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RetailHub - Point of Sale System</title>
    
    <!-- Prevent favicon 404 -->
    <link rel="icon" href="data:,">
    
    <!-- Font Awesome Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js" onerror="console.error('Failed to load Chart.js')"></script>
    
    <script>
        // ===== CHART.JS READY CHECK =====
        const chartJsReady = new Promise((resolve, reject) => {
            if (typeof Chart !== 'undefined') {
                resolve(Chart);
            } else {
                const checkChart = setInterval(() => {
                    if (typeof Chart !== 'undefined') {
                        clearInterval(checkChart);
                        resolve(Chart);
                    }
                }, 100);
                // Timeout after 5 seconds
                setTimeout(() => {
                    clearInterval(checkChart);
                    reject(new Error('Chart.js failed to load'));
                }, 5000);
            }
        });
    </script>
    
    <style>
        /* ===== CSS VARIABLES & THEMES ===== */
        :root {
            --bg-primary: #0f0f13;
            --bg-secondary: #1a1a1f;
            --bg-tertiary: #22222a;
            --bg-card: rgba(30, 30, 40, 0.95);
            --text-primary: #ffffff;
            --text-secondary: #a0a0b0;
            --text-muted: #6b6b7b;
            --primary: #6366f1;
            --secondary: #8b5cf6;
            --success: #10b981;
            --danger: #ef4444;
            --warning: #f59e0b;
            --info: #3b82f6;
            --border: rgba(255, 255, 255, 0.1);
            --border-light: rgba(255, 255, 255, 0.2);
            --shadow: rgba(0, 0, 0, 0.3);
            --gradient-primary: linear-gradient(135deg, #6366f1, #8b5cf6);
            --gradient-success: linear-gradient(135deg, #10b981, #34d399);
            --glass-bg: rgba(255, 255, 255, 0.05);
            --glass-border: rgba(255, 255, 255, 0.1);
        }

        [data-theme="light"] {
            --bg-primary: #f9fafb;
            --bg-secondary: #ffffff;
            --bg-tertiary: #f3f4f6;
            --bg-card: rgba(255, 255, 255, 0.95);
            --text-primary: #1f2937;
            --text-secondary: #4b5563;
            --text-muted: #6b7280;
            --border: rgba(0, 0, 0, 0.1);
            --border-light: rgba(0, 0, 0, 0.2);
            --shadow: rgba(0, 0, 0, 0.1);
            --glass-bg: rgba(255, 255, 255, 0.8);
            --glass-border: rgba(255, 255, 255, 0.9);
        }

        /* ===== GLOBAL STYLES ===== */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            line-height: 1.6;
            overflow-x: hidden;
            position: relative;
            transition: background 0.3s ease, color 0.3s ease;
        }

        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background:
                radial-gradient(circle at 20% 80%, rgba(120, 119, 198, 0.1) 0%, transparent 50%),
                radial-gradient(circle at 80% 20%, rgba(255, 119, 198, 0.1) 0%, transparent 50%),
                radial-gradient(circle at 40% 40%, rgba(120, 219, 226, 0.1) 0%, transparent 50%);
            pointer-events: none;
            z-index: -1;
        }

        /* ===== PRINT STYLES ===== */
        @media print {
            body * {
                visibility: hidden;
            }
            #receipt-container, #receipt-container * {
                visibility: visible !important;
            }
            #receipt-container {
                position: absolute;
                left: 0;
                top: 0;
                width: 100%;
                background: white;
                color: black;
            }
            @page {
                size: auto;
                margin: 5mm;
            }
        }

        /* ===== MOBILE MENU BUTTON ===== */
        .mobile-menu-btn {
            display: none;
            position: fixed;
            top: 20px;
            left: 20px;
            z-index: 101;
            background: var(--gradient-primary);
            color: white;
            border: none;
            border-radius: 8px;
            width: 40px;
            height: 40px;
            font-size: 1.2rem;
            cursor: pointer;
        }

        /* ===== SIDEBAR ===== */
        .sidebar {
            position: fixed;
            left: 0;
            top: 0;
            width: 280px;
            height: 100vh;
            background: var(--bg-secondary);
            border-right: 1px solid var(--border);
            padding: 2rem 0;
            z-index: 100;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            backdrop-filter: blur(20px);
            border-radius: 0 20px 20px 0;
            box-shadow: 4px 0 20px var(--shadow);
        }

        .sidebar::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: var(--gradient-primary);
            opacity: 0.05;
            border-radius: 0 20px 20px 0;
        }

        .logo {
            padding: 0 2rem 2rem;
            border-bottom: 1px solid var(--border);
            margin-bottom: 2rem;
            position: relative;
        }

        .logo h1 {
            font-size: 2rem;
            font-weight: 700;
            background: var(--gradient-primary);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            position: relative;
            animation: logoGlow 2s ease-in-out infinite alternate;
        }

        @keyframes logoGlow {
            from { filter: brightness(1); }
            to { filter: brightness(1.2); }
        }

        .nav-item {
            padding: 0.875rem 2rem;
            margin: 0.25rem 1rem;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            display: flex;
            align-items: center;
            gap: 0.875rem;
            font-weight: 500;
            position: relative;
            overflow: hidden;
        }

        .nav-item::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: var(--gradient-primary);
            transition: left 0.3s ease;
            z-index: -1;
        }

        .nav-item:hover::before {
            left: 0;
        }

        .nav-item:hover {
            transform: translateX(4px);
            color: white;
        }

        .nav-item.active {
            background: var(--gradient-primary);
            color: white;
            box-shadow: 0 4px 20px rgba(99, 102, 241, 0.3);
        }

        .nav-icon {
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.1rem;
        }

        /* ===== MAIN CONTENT ===== */
        .main-content {
            margin-left: 280px;
            padding: 2rem;
            min-height: 100vh;
            position: relative;
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
            padding: 2rem;
            background: var(--bg-card);
            border-radius: 16px;
            border: 1px solid var(--border);
            backdrop-filter: blur(20px);
            box-shadow: 0 8px 32px var(--shadow);
            position: relative;
            overflow: hidden;
        }

        .header::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: var(--gradient-primary);
        }

        .header h2 {
            font-size: 2.25rem;
            font-weight: 700;
            background: var(--gradient-primary);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin: 0;
        }

        .header-actions {
            display: flex;
            gap: 1rem;
            align-items: center;
        }

        /* ===== STORE SELECTOR ===== */
        .store-selector {
            display: flex;
            gap: 1rem;
            align-items: center;
        }

        .store-selector select {
            background: var(--bg-tertiary);
            color: var(--text-primary);
            border: 1px solid var(--border);
            padding: 0.875rem 1.25rem;
            border-radius: 12px;
            font-family: 'Inter', sans-serif;
            font-size: 0.95rem;
            cursor: pointer;
            transition: all 0.3s ease;
            min-width: 220px;
        }

        .store-selector select:hover {
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
        }

        .store-selector select:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.2);
        }

        /* ===== STATS GRID ===== */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .stat-card {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 16px;
            padding: 2rem;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
            backdrop-filter: blur(20px);
            box-shadow: 0 4px 20px var(--shadow);
        }

        .stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 4px;
            background: var(--gradient-primary);
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .stat-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 12px 40px var(--shadow);
            border-color: var(--border-light);
        }

        .stat-card:hover::before {
            opacity: 1;
        }

        .stat-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 1rem;
        }

        .stat-icon {
            width: 48px;
            height: 48px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.25rem;
            background: var(--gradient-primary);
            color: white;
        }

        .stat-label {
            color: var(--text-muted);
            font-size: 0.875rem;
            font-weight: 500;
            margin-bottom: 0.5rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .stat-value {
            font-size: 2.5rem;
            font-weight: 700;
            font-family: 'JetBrains Mono', monospace;
            margin-bottom: 0.5rem;
            background: var(--gradient-primary);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .stat-change {
            font-size: 0.875rem;
            font-weight: 600;
            display: inline-flex;
            align-items: center;
            gap: 0.25rem;
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            background: var(--glass-bg);
            border: 1px solid var(--glass-border);
        }

        .stat-change.positive {
            color: var(--success);
            background: rgba(16, 185, 129, 0.1);
            border-color: rgba(16, 185, 129, 0.2);
        }

        .stat-change.negative {
            color: var(--danger);
            background: rgba(239, 68, 68, 0.1);
            border-color: rgba(239, 68, 68, 0.2);
        }

        .stat-change.neutral {
            color: var(--text-secondary);
            background: rgba(148, 163, 184, 0.1);
            border-color: rgba(148, 163, 184, 0.2);
        }

        /* ===== SECTIONS ===== */
        .section {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 16px;
            padding: 2rem;
            margin-bottom: 2rem;
            backdrop-filter: blur(20px);
            box-shadow: 0 4px 20px var(--shadow);
            position: relative;
            overflow: hidden;
        }

        .section::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 2px;
            background: var(--gradient-primary);
            opacity: 0.3;
        }

        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
        }

        .section-title {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--text-primary);
            margin: 0;
        }

        /* ===== BUTTONS ===== */
        .btn {
            padding: 0.875rem 1.75rem;
            border-radius: 12px;
            border: none;
            font-family: 'Inter', sans-serif;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.95rem;
            position: relative;
            overflow: hidden;
            text-decoration: none;
        }

        .btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
            transition: left 0.5s ease;
        }

        .btn:hover::before {
            left: 100%;
        }

        .btn-primary {
            background: var(--gradient-primary);
            color: white;
            box-shadow: 0 4px 20px rgba(99, 102, 241, 0.3);
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 30px rgba(99, 102, 241, 0.4);
        }

        .btn-secondary {
            background: var(--bg-tertiary);
            color: var(--text-primary);
            border: 1px solid var(--border);
        }

        .btn-secondary:hover {
            background: var(--border);
            border-color: var(--border-light);
            transform: translateY(-1px);
        }

        .btn-success {
            background: var(--gradient-success);
            color: white;
            box-shadow: 0 4px 20px rgba(16, 185, 129, 0.3);
        }

        .btn-danger {
            background: linear-gradient(135deg, var(--danger), #f87171);
            color: white;
            box-shadow: 0 4px 20px rgba(239, 68, 68, 0.3);
        }

        .btn-info {
            background: linear-gradient(135deg, var(--info), #60a5fa);
            color: white;
        }

        .btn-warning {
            background: linear-gradient(135deg, var(--warning), #fbbf24);
            color: white;
        }

        .btn-outline {
            background: transparent;
            border: 2px solid var(--primary);
            color: var(--primary);
        }

        .btn-outline:hover {
            background: var(--primary);
            color: white;
        }

        .btn-sm {
            padding: 0.5rem 0.75rem;
            font-size: 0.875rem;
            border-radius: 6px;
        }

        /* ===== TABLES ===== */
        .table-container {
            overflow-x: auto;
            border-radius: 12px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border);
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th {
            text-align: left;
            padding: 1.25rem 1.5rem;
            border-bottom: 2px solid var(--border);
            font-weight: 600;
            color: var(--text-secondary);
            font-size: 0.875rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            background: var(--bg-secondary);
        }

        td {
            padding: 1.25rem 1.5rem;
            border-bottom: 1px solid var(--border);
            transition: all 0.2s ease;
        }

        tr:hover {
            background: var(--bg-secondary);
        }

        tr:hover td {
            background: var(--bg-secondary);
        }

        /* ===== FORMS ===== */
        .form-group {
            margin-bottom: 1.75rem;
        }

        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 600;
            color: var(--text-secondary);
            font-size: 0.9rem;
        }

        .form-input {
            width: 100%;
            padding: 0.875rem 1rem;
            background: var(--bg-tertiary);
            border: 1px solid var(--border);
            border-radius: 12px;
            color: var(--text-primary);
            font-family: 'Inter', sans-serif;
            font-size: 1rem;
            transition: all 0.3s ease;
        }

        .form-input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
            background: var(--bg-secondary);
        }

        .form-input:hover {
            border-color: var(--border-light);
        }

        textarea.form-input {
            resize: vertical;
            min-height: 100px;
        }

        /* ===== MODALS ===== */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 1000;
            align-items: center;
            justify-content: center;
            backdrop-filter: blur(8px);
            animation: modalFadeIn 0.3s ease;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 20px;
            padding: 2.5rem;
            max-width: 600px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            animation: modalSlideIn 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
            backdrop-filter: blur(20px);
            box-shadow: 0 20px 60px var(--shadow);
            position: relative;
        }

        .modal-content::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: var(--gradient-primary);
            border-radius: 20px 20px 0 0;
        }

        @keyframes modalFadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        @keyframes modalSlideIn {
            from {
                opacity: 0;
                transform: translateY(-20px) scale(0.95);
            }
            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
        }

        .modal-title {
            font-size: 1.75rem;
            font-weight: 700;
            color: var(--text-primary);
            margin: 0;
        }

        .close-btn {
            background: var(--bg-tertiary);
            border: 1px solid var(--border);
            color: var(--text-secondary);
            font-size: 1.25rem;
            cursor: pointer;
            padding: 0.5rem;
            border-radius: 8px;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
        }

        .close-btn:hover {
            background: var(--danger);
            color: white;
            border-color: var(--danger);
        }

        /* ===== POS SPECIFIC ===== */
        .pos-grid {
            display: grid;
            grid-template-columns: 1fr 350px;
            gap: 2rem;
        }

        .product-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
            gap: 1rem;
            margin-top: 1rem;
        }

        .product-card {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 16px;
            padding: 1.5rem;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            text-align: center;
            position: relative;
            overflow: hidden;
            backdrop-filter: blur(20px);
            box-shadow: 0 4px 20px var(--shadow);
        }

        .product-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: var(--gradient-primary);
            transform: scaleX(0);
            transition: transform 0.3s ease;
        }

        .product-card:hover {
            transform: translateY(-4px) scale(1.02);
            box-shadow: 0 12px 40px var(--shadow);
            border-color: var(--primary);
        }

        .product-card:hover::before {
            transform: scaleX(1);
        }

        .product-card.low-stock {
            border-color: var(--warning);
        }

        .product-card.out-of-stock {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .product-image {
            width: 60px;
            height: 60px;
            margin: 0 auto 1rem;
            background: var(--gradient-primary);
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            color: white;
        }

        .product-name {
            font-weight: 600;
            margin-bottom: 0.5rem;
            color: var(--text-primary);
        }

        .product-price {
            font-family: 'JetBrains Mono', monospace;
            color: var(--primary);
            font-weight: 600;
            font-size: 1.1rem;
        }

        .product-stock {
            font-size: 0.75rem;
            color: var(--text-muted);
            margin-top: 0.5rem;
        }

        .cart {
            background: var(--bg-card);
            border-radius: 16px;
            padding: 2rem;
            position: sticky;
            top: 2rem;
            backdrop-filter: blur(20px);
            border: 1px solid var(--border);
            box-shadow: 0 4px 20px var(--shadow);
        }

        .cart-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
        }

        .cart-title {
            font-size: 1.25rem;
            font-weight: 700;
            margin: 0;
        }

        .cart-count {
            background: var(--gradient-primary);
            color: white;
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 600;
        }

        .cart-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem 0;
            border-bottom: 1px solid var(--border);
            transition: all 0.2s ease;
        }

        .cart-item:hover {
            background: var(--bg-tertiary);
            border-radius: 8px;
            padding: 1rem;
            margin: 0 -1rem;
        }

        .cart-item-info {
            flex: 1;
        }

        .cart-item-name {
            font-weight: 600;
            margin-bottom: 0.25rem;
        }

        .cart-item-price {
            color: var(--text-muted);
            font-size: 0.875rem;
        }

        .cart-item-qty {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .qty-btn {
            background: var(--bg-tertiary);
            border: 1px solid var(--border);
            color: var(--text-primary);
            width: 32px;
            height: 32px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .qty-btn:hover {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
        }

        .cart-total {
            margin-top: 2rem;
            padding-top: 2rem;
            border-top: 2px solid var(--border);
        }

        .total-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 0.75rem;
            font-size: 1.25rem;
            font-weight: 700;
        }

        .total-row.subtotal {
            font-size: 1rem;
            font-weight: 500;
            color: var(--text-secondary);
        }

        .total-row.tax {
            font-size: 1rem;
            font-weight: 500;
            color: var(--text-secondary);
        }

        /* ===== ORDER TYPE SELECTOR ===== */
        .order-type-selector {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 1.5rem;
            padding: 0.5rem;
            background: var(--bg-tertiary);
            border-radius: 12px;
            border: 1px solid var(--border);
        }

        .order-type-btn {
            flex: 1;
            padding: 0.75rem;
            border: none;
            border-radius: 8px;
            background: transparent;
            color: var(--text-secondary);
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            font-size: 0.875rem;
            font-weight: 500;
        }

        .order-type-btn:hover {
            background: var(--bg-secondary);
            color: var(--text-primary);
        }

        .order-type-btn.active {
            background: var(--gradient-primary);
            color: white;
            box-shadow: 0 2px 8px rgba(99, 102, 241, 0.3);
        }

        /* ===== QUANTITY PRESETS ===== */
        .quantity-presets {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            margin-bottom: 1.5rem;
            padding: 0.75rem;
            background: var(--bg-tertiary);
            border-radius: 8px;
            border: 1px solid var(--border);
        }

        .quantity-presets span {
            font-size: 0.875rem;
            color: var(--text-secondary);
            font-weight: 500;
        }

        .qty-preset {
            padding: 0.5rem 0.75rem;
            border: 1px solid var(--border);
            border-radius: 6px;
            background: var(--bg-secondary);
            color: var(--text-primary);
            cursor: pointer;
            transition: all 0.2s ease;
            font-weight: 600;
            min-width: 40px;
        }

        .qty-preset:hover {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
        }

        /* ===== RECENT SALES LIST ===== */
        .recent-sales-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 1rem;
        }

        .recent-sale-item {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 1rem;
            cursor: pointer;
            transition: all 0.3s ease;
            backdrop-filter: blur(20px);
        }

        .recent-sale-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px var(--shadow);
            border-color: var(--primary);
        }

        .recent-sale-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.5rem;
        }

        .recent-sale-id {
            font-weight: 600;
            color: var(--primary);
        }

        .recent-sale-time {
            font-size: 0.75rem;
            color: var(--text-muted);
        }

        .recent-sale-customer {
            font-size: 0.875rem;
            color: var(--text-secondary);
            margin-bottom: 0.5rem;
        }

        .recent-sale-total {
            font-weight: 700;
            font-family: 'JetBrains Mono', monospace;
            color: var(--success);
        }

        /* ===== SEARCH BOX ===== */
        .search-box {
            position: relative;
            margin-bottom: 2rem;
        }

        .search-input {
            width: 100%;
            padding: 1rem 1rem 1rem 3rem;
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 12px;
            color: var(--text-primary);
            font-family: 'Inter', sans-serif;
            font-size: 1rem;
            transition: all 0.3s ease;
            backdrop-filter: blur(20px);
            box-shadow: 0 4px 20px var(--shadow);
        }

        .search-input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
            background: var(--bg-secondary);
        }

        .search-input::placeholder {
            color: var(--text-muted);
        }

        .search-icon {
            position: absolute;
            left: 1rem;
            top: 50%;
            transform: translateY(-50%);
            color: var(--text-muted);
            font-size: 1.1rem;
        }

        /* ===== ALERTS ===== */
        .alert {
            padding: 1.25rem 1.5rem;
            border-radius: 12px;
            margin-bottom: 1.25rem;
            border-left: 4px solid;
            backdrop-filter: blur(20px);
            position: relative;
            overflow: hidden;
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .alert::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: var(--glass-bg);
            border: 1px solid var(--glass-border);
        }

        .alert > * {
            position: relative;
            z-index: 1;
        }

        .alert-warning {
            border-color: var(--warning);
            background: rgba(245, 158, 11, 0.1);
        }

        .alert-danger {
            border-color: var(--danger);
            background: rgba(239, 68, 68, 0.1);
        }

        .alert-success {
            border-color: var(--success);
            background: rgba(16, 185, 129, 0.1);
        }

        .alert-info {
            border-color: var(--info);
            background: rgba(59, 130, 246, 0.1);
        }

        /* ===== BADGES ===== */
        .badge {
            display: inline-block;
            padding: 0.375rem 0.875rem;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .badge-success {
            background: rgba(16, 185, 129, 0.2);
            color: var(--success);
            border: 1px solid rgba(16, 185, 129, 0.3);
        }

        .badge-warning {
            background: rgba(245, 158, 11, 0.2);
            color: var(--warning);
            border: 1px solid rgba(245, 158, 11, 0.3);
        }

        .badge-danger {
            background: rgba(239, 68, 68, 0.2);
            color: var(--danger);
            border: 1px solid rgba(239, 68, 68, 0.3);
        }

        .badge-info {
            background: rgba(59, 130, 246, 0.2);
            color: var(--info);
            border: 1px solid rgba(59, 130, 246, 0.3);
        }

        /* ===== TABS ===== */
        .tab-container {
            display: flex;
            gap: 1rem;
            margin-bottom: 2rem;
            border-bottom: 2px solid var(--border);
            padding-bottom: 1rem;
        }

        .tab {
            padding: 1rem 1.5rem;
            cursor: pointer;
            border-bottom: 2px solid transparent;
            margin-bottom: -2px;
            transition: all 0.3s ease;
            font-weight: 600;
            color: var(--text-secondary);
            border-radius: 8px 8px 0 0;
            position: relative;
        }

        .tab:hover {
            color: var(--text-primary);
            background: var(--bg-tertiary);
        }

        .tab.active {
            color: var(--primary);
            border-color: var(--primary);
            background: rgba(99, 102, 241, 0.1);
        }

        .view {
            display: none;
            animation: fadeIn 0.4s ease;
        }

        .view.active {
            display: block;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* ===== DISCOUNT TABS ===== */
        .discount-tab {
            display: none;
        }

        .discount-tab.active {
            display: block;
        }

        /* ===== PAYMENT OPTIONS ===== */
        .payment-options {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 0.75rem;
            margin-bottom: 1.5rem;
        }

        .payment-option {
            padding: 1rem;
            border: 2px solid var(--border);
            border-radius: 8px;
            background: var(--bg-tertiary);
            color: var(--text-primary);
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            font-weight: 500;
        }

        .payment-option:hover {
            border-color: var(--primary);
            background: rgba(99, 102, 241, 0.1);
        }

        .payment-option.active {
            border-color: var(--primary);
            background: var(--gradient-primary);
            color: white;
        }

        .payment-details {
            display: none;
        }

        .payment-details.active {
            display: block;
        }

        /* ===== CUSTOMER OPTIONS ===== */
        .customer-option {
            padding: 0.875rem 1.25rem;
            cursor: pointer;
            transition: all 0.2s ease;
            border-radius: 8px;
            margin-bottom: 0.25rem;
        }

        .customer-option:hover {
            background: var(--bg-tertiary);
        }

        /* ===== THERMAL RECEIPT ===== */
        .thermal-receipt {
            max-width: 220px;
            font-family: 'Courier New', Courier, monospace;
            font-size: 12px;
            line-height: 1.2;
            color: #000;
            background: #fff;
            padding: 6px;
            margin: 0 auto;
        }

        .thermal-receipt .title { 
            font-size: 14px; 
            font-weight: 700; 
            margin-bottom: 6px; 
        }
        
        .thermal-receipt table { 
            width: 100%; 
            border-collapse: collapse; 
            margin-bottom: 6px; 
        }
        
        .thermal-receipt td, 
        .thermal-receipt th { 
            padding: 2px 0; 
        }
        
        .thermal-receipt .small { 
            font-size: 11px; 
            color: #333; 
        }
        
        .thermal-receipt .totals { 
            font-weight: 700; 
            margin-top: 4px; 
        }

        @media print {
            body.thermal-print { 
                margin: 0; 
            }
            .thermal-receipt { 
                padding: 2px; 
                font-size: 11px; 
            }
        }

        /* ===== NOTIFICATION SYSTEM ===== */
        .notification-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 2000;
            max-width: 400px;
        }

        .notification {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 1rem 1.25rem;
            margin-bottom: 1rem;
            box-shadow: 0 8px 32px var(--shadow);
            backdrop-filter: blur(20px);
            animation: slideInRight 0.3s ease;
            display: flex;
            align-items: flex-start;
            gap: 0.75rem;
        }

        .notification.success {
            border-left: 4px solid var(--success);
        }

        .notification.error {
            border-left: 4px solid var(--danger);
        }

        .notification.warning {
            border-left: 4px solid var(--warning);
        }

        .notification.info {
            border-left: 4px solid var(--info);
        }

        .notification-icon {
            font-size: 1.25rem;
            margin-top: 0.125rem;
        }

        .notification-content {
            flex: 1;
        }

        .notification-title {
            font-weight: 600;
            margin-bottom: 0.25rem;
        }

        .notification-message {
            font-size: 0.875rem;
            color: var(--text-secondary);
        }

        .notification-close {
            background: none;
            border: none;
            color: var(--text-muted);
            cursor: pointer;
            padding: 0.25rem;
            border-radius: 4px;
            transition: all 0.2s ease;
        }

        .notification-close:hover {
            background: var(--bg-tertiary);
            color: var(--text-primary);
        }

        @keyframes slideInRight {
            from {
                opacity: 0;
                transform: translateX(100%);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        /* ===== CHART CONTAINERS ===== */
        .chart-container {
            height: 350px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: var(--bg-card);
            border-radius: 16px;
            border: 1px solid var(--border);
            backdrop-filter: blur(20px);
            box-shadow: 0 4px 20px var(--shadow);
            position: relative;
            overflow: hidden;
        }

        .chart-container::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 2px;
            background: var(--gradient-primary);
        }

        canvas {
            max-width: 100%;
            max-height: 100%;
        }

        /* ===== THEME TOGGLE ===== */
        .theme-toggle {
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: var(--gradient-primary);
            border: none;
            color: white;
            cursor: pointer;
            box-shadow: 0 4px 20px rgba(99, 102, 241, 0.3);
            transition: all 0.3s ease;
            z-index: 100;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.25rem;
        }

        .theme-toggle:hover {
            transform: scale(1.1);
            box-shadow: 0 8px 30px rgba(99, 102, 241, 0.4);
        }

        /* ===== LOADING SPINNER ===== */
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 2px solid var(--border);
            border-radius: 50%;
            border-top-color: var(--primary);
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* ===== RESPONSIVE DESIGN ===== */
        @media (max-width: 1024px) {
            .sidebar {
                transform: translateX(-100%);
            }
            .sidebar.mobile-open {
                transform: translateX(0);
            }
            .main-content {
                margin-left: 0;
            }
            .mobile-menu-btn {
                display: block;
            }
            .pos-grid {
                grid-template-columns: 1fr;
            }
            .cart {
                position: static;
            }
        }

        @media (max-width: 768px) {
            .stats-grid {
                grid-template-columns: 1fr;
            }
            .header {
                flex-direction: column;
                gap: 1rem;
                text-align: center;
            }
            .header h2 {
                font-size: 1.5rem;
            }
            .store-selector {
                justify-content: center;
            }
            .section-header {
                flex-direction: column;
                gap: 1rem;
                align-items: flex-start;
            }
            .pos-bottom-bar {
                flex-direction: column;
                padding: 1rem !important;
            }
            .pos-bottom-bar > div:first-child {
                flex-wrap: wrap;
                justify-content: center;
            }
        }

        @media (max-width: 480px) {
            .main-content {
                padding: 1rem;
            }
            .product-grid {
                grid-template-columns: 1fr;
            }
            .modal-content {
                padding: 1.5rem;
            }
            .payment-options {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body data-theme="dark">
    <!-- Receipt Container -->
    <div id="receipt-container" style="display: none;"></div>

    <!-- Sidebar -->
    <div class="sidebar" id="sidebar">
        <div class="logo">
            <h1>RetailHub</h1>
        </div>
        <nav>
            <div class="nav-item active" data-view="dashboard">
                <span class="nav-icon">üìä</span>
                Dashboard
            </div>
            <div class="nav-item" data-view="pos">
                <span class="nav-icon">üõí</span>
                Point of Sale
            </div>
            <div class="nav-item" data-view="inventory">
                <span class="nav-icon">üì¶</span>
                Inventory
            </div>
            <div class="nav-item" data-view="sales">
                <span class="nav-icon">üí∞</span>
                Sales Reports
            </div>
            <div class="nav-item" data-view="customers">
                <span class="nav-icon">üë•</span>
                Customers
            </div>
            <div class="nav-item" data-view="analytics">
                <span class="nav-icon">üìà</span>
                Analytics
            </div>
            <div class="nav-item" data-view="stores">
                <span class="nav-icon">üè™</span>
                Stores
            </div>
            <div class="nav-item" data-view="settings">
                <span class="nav-icon">‚öôÔ∏è</span>
                Settings
            </div>
        </nav>
    </div>

    <!-- Mobile Menu Button -->
    <button class="mobile-menu-btn" onclick="toggleMobileMenu()">
        <i class="fas fa-bars"></i>
    </button>

    <!-- Theme Toggle -->
    <button class="theme-toggle" onclick="toggleTheme()" title="Toggle Theme">
        <i class="fas fa-moon"></i>
    </button>

    <!-- Notification Container -->
    <div class="notification-container" id="notificationContainer"></div>

    <!-- Main Content -->
    <div class="main-content">
        <!-- Dashboard View -->
        <div class="view active" id="dashboard">
            <div class="header">
                <h2>Dashboard</h2>
                <div class="header-actions">
                    <button class="btn btn-outline" onclick="exportData()">
                        <i class="fas fa-download"></i>
                        Export
                    </button>
                    <div class="store-selector">
                        <select id="storeSelect">
                            <option value="all">All Stores</option>
                            <option value="store1">Downtown Store</option>
                            <option value="store2">Mall Location</option>
                            <option value="store3">Airport Branch</option>
                        </select>
                    </div>
                </div>
            </div>

            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-header">
                        <div class="stat-icon">
                            <i class="fas fa-rupee-sign"></i>
                        </div>
                        <div>
                            <div class="stat-label">Today's Sales</div>
                            <div class="stat-value" id="todaySales">‚Çπ45,231</div>
                            <div class="stat-change neutral">
                                <i class="fas fa-info-circle"></i>
                                Real-time data
                            </div>
                        </div>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-header">
                        <div class="stat-icon">
                            <i class="fas fa-boxes"></i>
                        </div>
                        <div>
                            <div class="stat-label">Total Inventory</div>
                            <div class="stat-value" id="totalInventory">2,847</div>
                            <div class="stat-change neutral">
                                <i class="fas fa-info-circle"></i>
                                Real-time data
                            </div>
                        </div>
                    </div>
                </div>
                <div class="stat-card warning">
                    <div class="stat-header">
                        <div class="stat-icon">
                            <i class="fas fa-exclamation-triangle"></i>
                        </div>
                        <div>
                            <div class="stat-label">Low Stock Items</div>
                            <div class="stat-value" id="lowStockItems">24</div>
                            <div class="stat-change neutral">
                                <i class="fas fa-info-circle"></i>
                                Needs attention
                            </div>
                        </div>
                    </div>
                </div>
                <div class="stat-card success">
                    <div class="stat-header">
                        <div class="stat-icon">
                            <i class="fas fa-chart-line"></i>
                        </div>
                        <div>
                            <div class="stat-label">Monthly Revenue</div>
                            <div class="stat-value" id="monthlyRevenue">‚Çπ12.4L</div>
                            <div class="stat-change neutral">
                                <i class="fas fa-info-circle"></i>
                                Real-time data
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="section">
                <div class="section-header">
                    <h3 class="section-title">Quick Actions</h3>
                </div>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem;">
                    <button class="btn btn-primary" onclick="openAddProductModal()">
                        <i class="fas fa-plus"></i>
                        Add Product
                    </button>
                    <button class="btn btn-success" onclick="openModal('quickSaleModal')">
                        <i class="fas fa-shopping-cart"></i>
                        Quick Sale
                    </button>
                    <button class="btn btn-info" onclick="generateReport()">
                        <i class="fas fa-chart-bar"></i>
                        Generate Report
                    </button>
                    <button class="btn btn-warning" onclick="openModal('lowStockModal')">
                        <i class="fas fa-exclamation-triangle"></i>
                        Low Stock Alert
                    </button>
                </div>
            </div>

            <div class="section">
                <div class="section-header">
                    <h3 class="section-title">Inventory Alerts</h3>
                </div>
                <div class="alert alert-danger">
                    <i class="fas fa-times-circle"></i>
                    <div>
                        <strong>Critical Stock:</strong> 8 items are out of stock across all stores
                    </div>
                </div>
                <div class="alert alert-warning">
                    <i class="fas fa-exclamation-triangle"></i>
                    <div>
                        <strong>Low Stock:</strong> 16 items are below minimum threshold
                    </div>
                </div>
                <div class="alert alert-info">
                    <i class="fas fa-info-circle"></i>
                    <div>
                        <strong>Info:</strong> 5 new products added this week
                    </div>
                </div>
            </div>

            <div class="section">
                <div class="section-header">
                    <h3 class="section-title">Recent Transactions</h3>
                    <button class="btn btn-secondary" onclick="viewAllTransactions()">
                        View All
                    </button>
                </div>
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>Invoice #</th>
                                <th>Store</th>
                                <th>Customer</th>
                                <th>Date</th>
                                <th>Amount</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="recentTransactions">
                            <!-- Transactions will be loaded dynamically -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- POS View -->
        <div class="view" id="pos">
            <div class="header">
                <h2>Point of Sale</h2>
            </div>

            <div class="pos-grid">
                <div>
                    <div class="search-box">
                        <span class="search-icon"><i class="fas fa-search"></i></span>
                        <input type="text" class="search-input" id="productSearch" placeholder="Search products... (Press F2 for barcode)">
                    </div>

                    <div class="order-type-selector">
                        <button class="order-type-btn active" onclick="selectOrderType('retail', event)">
                            <i class="fas fa-shopping-bag"></i>
                            Retail
                        </button>
                        <button class="order-type-btn" onclick="selectOrderType('wholesale', event)">
                            <i class="fas fa-truck"></i>
                            Wholesale
                        </button>
                        <button class="order-type-btn" onclick="selectOrderType('return', event)">
                            <i class="fas fa-undo"></i>
                            Return
                        </button>
                    </div>

                    <div class="tab-container">
                        <div class="tab active" data-category="all">All</div>
                        <div class="tab" data-category="Electronics">Electronics</div>
                        <div class="tab" data-category="Accessories">Accessories</div>
                        <div class="tab" data-category="Clothing">Clothing</div>
                        <div class="tab" data-category="Home & Garden">Home & Garden</div>
                    </div>

                    <div class="quantity-presets">
                        <span>Quick Qty:</span>
                        <button class="qty-preset" onclick="addQuantityPreset(1)">1</button>
                        <button class="qty-preset" onclick="addQuantityPreset(2)">2</button>
                        <button class="qty-preset" onclick="addQuantityPreset(5)">5</button>
                        <button class="qty-preset" onclick="addQuantityPreset(10)">10</button>
                    </div>

                    <div class="product-grid" id="productGrid">
                        <!-- Products will be added dynamically -->
                    </div>
                </div>

                <div class="cart">
                    <div class="cart-header">
                        <h3 class="cart-title">Current Sale</h3>
                        <div style="display: flex; gap: 0.5rem; align-items: center;">
                            <span class="cart-count" id="cartCount">0</span>
                            <button class="btn btn-sm" onclick="openModal('cartOptionsModal')" title="Cart Options">
                                <i class="fas fa-ellipsis-v"></i>
                            </button>
                        </div>
                    </div>

                    <div id="appliedDiscounts" style="display: none; margin-bottom: 1rem;">
                        <div style="font-size: 0.875rem; color: var(--text-secondary); margin-bottom: 0.5rem;">
                            Applied Discounts:
                        </div>
                        <div id="discountList"></div>
                    </div>

                    <div id="cartItems">
                        <div style="text-align: center; color: var(--text-secondary); padding: 3rem 1rem;">
                            <i class="fas fa-shopping-cart" style="font-size: 3rem; margin-bottom: 1rem; opacity: 0.5;"></i>
                            <p>Cart is empty</p>
                            <small>Add products to start selling</small>
                        </div>
                    </div>

                    <div class="cart-total" id="cartTotal" style="display: none;">
                        <div class="total-row subtotal">
                            <span>Subtotal:</span>
                            <span id="subtotalAmount">‚Çπ0</span>
                        </div>
                        <div class="total-row discount" id="discountRow" style="display: none;">
                            <span>Discount:</span>
                            <span id="discountAmount">-‚Çπ0</span>
                        </div>
                        <div class="total-row tax">
                            <span>Tax (18%):</span>
                            <span id="taxAmount">‚Çπ0</span>
                        </div>
                        <div class="total-row">
                            <span>Total:</span>
                            <span id="totalAmount">‚Çπ0</span>
                        </div>

                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.5rem; margin-top: 1rem;">
                            <button class="btn btn-success" onclick="openPaymentModal()">
                                <i class="fas fa-check"></i>
                                Pay Now
                            </button>
                            <button class="btn btn-secondary" onclick="clearCart()">
                                <i class="fas fa-trash"></i>
                                Clear Cart
                            </button>
                        </div>
                        <button class="btn btn-outline" style="width: 100%; margin-top: 0.5rem;" onclick="holdSale()">
                            <i class="fas fa-pause"></i>
                            Hold Sale
                        </button>
                    </div>
                </div>
            </div>

            <div class="section" style="margin-top: 2rem;">
                <div class="section-header">
                    <h3 class="section-title">Recent Sales</h3>
                    <button class="btn btn-secondary" onclick="loadRecentSales()">
                        <i class="fas fa-sync"></i>
                        Refresh
                    </button>
                </div>
                <div id="recentSalesList" class="recent-sales-list">
                    <!-- Recent sales will be loaded here -->
                </div>
            </div>

            <div class="pos-bottom-bar" style="position: sticky; bottom: 0; background: var(--bg-card); padding: 1rem; border-top: 1px solid var(--border); margin: 1rem -2rem -2rem -2rem; display: flex; gap: 1rem; align-items: center; justify-content: space-between; z-index: 100;">
                <div style="display: flex; gap: 1rem; align-items: center;">
                    <button class="btn btn-outline" onclick="scanBarcode()">
                        <i class="fas fa-qrcode"></i>
                        Scan Barcode
                    </button>
                    <button class="btn btn-secondary" onclick="openModal('customerModal')">
                        <i class="fas fa-user"></i>
                        Customer
                    </button>
                    <button class="btn btn-info" onclick="openDiscountModal()">
                        <i class="fas fa-percent"></i>
                        Discount
                    </button>
                </div>
                <div class="store-selector">
                    <select>
                        <option value="store1">Downtown Store</option>
                        <option value="store2">Mall Location</option>
                        <option value="store3">Airport Branch</option>
                    </select>
                </div>
            </div>
        </div>

        <!-- Inventory View -->
        <div class="view" id="inventory">
            <div class="header">
                <h2>Inventory Management</h2>
                <button class="btn btn-primary" onclick="openAddProductModal()">
                    + Add Product
                </button>
            </div>

            <div class="search-box">
                <span class="search-icon">üîç</span>
                <input type="text" class="search-input" id="inventorySearch" placeholder="Search inventory...">
            </div>

            <div class="section">
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>Product</th>
                                <th>Category</th>
                                <th>Stock</th>
                                <th>MRP</th>
                                <th>Cost</th>
                                <th>Selling</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="inventoryTable">
                            <!-- Inventory items will be added dynamically -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Sales Reports View -->
        <div class="view" id="sales">
            <div class="header">
                <h2>Sales Reports</h2>
                <div class="header-actions">
                    <select id="reportPeriod" style="padding: 0.5rem 1rem; border-radius: 8px; border: 1px solid var(--border); background: var(--bg-tertiary); color: var(--text-primary); margin-right: 0.5rem;">
                        <option value="today">Today</option>
                        <option value="week">This Week</option>
                        <option value="month" selected>This Month</option>
                        <option value="year">This Year</option>
                        <option value="all">All Time</option>
                    </select>
                    <button class="btn btn-outline" id="exportSalesBtn">
                        <i class="fas fa-download"></i>
                        Export CSV
                    </button>
                    <button class="btn btn-primary" id="refreshSalesBtn">
                        <i class="fas fa-sync"></i>
                        Refresh
                    </button>
                </div>
            </div>

            <div class="stats-grid" id="salesStatsGrid">
                <div class="stat-card">
                    <div class="stat-header">
                        <div class="stat-icon">
                            <i class="fas fa-rupee-sign"></i>
                        </div>
                        <div>
                            <div class="stat-label">Total Revenue</div>
                            <div class="stat-value" id="totalRevenue">‚Çπ0</div>
                            <div class="stat-change neutral" id="revenueChange">
                                <i class="fas fa-minus"></i>
                                No comparison data
                            </div>
                        </div>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-header">
                        <div class="stat-icon">
                            <i class="fas fa-receipt"></i>
                        </div>
                        <div>
                            <div class="stat-label">Total Transactions</div>
                            <div class="stat-value" id="totalTransactions">0</div>
                            <div class="stat-change neutral" id="transactionsChange">
                                <i class="fas fa-minus"></i>
                                No comparison data
                            </div>
                        </div>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-header">
                        <div class="stat-icon">
                            <i class="fas fa-chart-line"></i>
                        </div>
                        <div>
                            <div class="stat-label">Avg. Transaction</div>
                            <div class="stat-value" id="avgTransaction">‚Çπ0</div>
                            <div class="stat-change neutral" id="avgChange">
                                <i class="fas fa-minus"></i>
                                No comparison data
                            </div>
                        </div>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-header">
                        <div class="stat-icon">
                            <i class="fas fa-box"></i>
                        </div>
                        <div>
                            <div class="stat-label">Items Sold</div>
                            <div class="stat-value" id="totalItems">0</div>
                            <div class="stat-change neutral" id="itemsChange">
                                <i class="fas fa-minus"></i>
                                No comparison data
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="section">
                <div class="section-header">
                    <h3 class="section-title">Sales Chart</h3>
                    <select id="chartType" style="padding: 0.5rem 1rem; border-radius: 8px; border: 1px solid var(--border); background: var(--bg-tertiary); color: var(--text-primary);">
                        <option value="daily">Daily</option>
                        <option value="weekly">Weekly</option>
                        <option value="monthly" selected>Monthly</option>
                    </select>
                </div>
                <div class="chart-container">
                    <canvas id="salesTrendChart"></canvas>
                </div>
            </div>

            <div class="section">
                <div class="section-header">
                    <h3 class="section-title">Top Selling Products</h3>
                    <span style="color: var(--text-secondary); font-size: 0.875rem;" id="topProductsCount">0 products</span>
                </div>
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>Product</th>
                                <th>Units Sold</th>
                                <th>Revenue</th>
                                <th>Avg. Price</th>
                            </tr>
                        </thead>
                        <tbody id="topProductsTable">
                            <tr>
                                <td colspan="4" style="text-align: center; padding: 2rem; color: var(--text-secondary);">
                                    <i class="fas fa-shopping-bag" style="font-size: 2rem; margin-bottom: 1rem; opacity: 0.5; display: block;"></i>
                                    No sales data yet. Start selling to see your top products!
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <div class="section">
                <div class="section-header">
                    <h3 class="section-title">Recent Transactions</h3>
                    <button class="btn btn-secondary btn-sm" id="clearAllSalesBtn">
                        <i class="fas fa-trash"></i>
                        Clear All Sales
                    </button>
                </div>
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>Invoice #</th>
                                <th>Date & Time</th>
                                <th>Items</th>
                                <th>Customer</th>
                                <th>Payment</th>
                                <th>Amount</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="recentTransactionsTable">
                            <tr>
                                <td colspan="7" style="text-align: center; padding: 2rem; color: var(--text-secondary);">
                                    <i class="fas fa-receipt" style="font-size: 2rem; margin-bottom: 1rem; opacity: 0.5; display: block;"></i>
                                    No transactions yet. Complete a sale to see it here!
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <div class="section">
                <div class="section-header">
                    <h3 class="section-title">Payment Methods Breakdown</h3>
                </div>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem;" id="paymentMethodsChart">
                    <div style="text-align: center; padding: 2rem; color: var(--text-secondary);">
                        <i class="fas fa-credit-card" style="font-size: 2rem; margin-bottom: 1rem; opacity: 0.5;"></i>
                        <p>No payment data</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Customers View -->
        <div class="view" id="customers">
            <div class="header">
                <h2>Customer Management</h2>
                <button class="btn btn-primary" onclick="openModal('addCustomerModal')">
                    <i class="fas fa-plus"></i>
                    Add Customer
                </button>
            </div>

            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-header">
                        <div class="stat-icon">
                            <i class="fas fa-users"></i>
                        </div>
                        <div>
                            <div class="stat-label">Total Customers</div>
                            <div class="stat-value">1,247</div>
                            <div class="stat-change positive">
                                <i class="fas fa-arrow-up"></i>
                                15 new this month
                            </div>
                        </div>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-header">
                        <div class="stat-icon">
                            <i class="fas fa-star"></i>
                        </div>
                        <div>
                            <div class="stat-label">VIP Customers</div>
                            <div class="stat-value">89</div>
                            <div class="stat-change positive">
                                <i class="fas fa-arrow-up"></i>
                                5% of total
                            </div>
                        </div>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-header">
                        <div class="stat-icon">
                            <i class="fas fa-shopping-cart"></i>
                        </div>
                        <div>
                            <div class="stat-label">Avg. Order Value</div>
                            <div class="stat-value">‚Çπ2,450</div>
                            <div class="stat-change positive">
                                <i class="fas fa-arrow-up"></i>
                                8.2% increase
                            </div>
                        </div>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-header">
                        <div class="stat-icon">
                            <i class="fas fa-calendar-alt"></i>
                        </div>
                        <div>
                            <div class="stat-label">Repeat Customers</div>
                            <div class="stat-value">67%</div>
                            <div class="stat-change positive">
                                <i class="fas fa-arrow-up"></i>
                                12% from last month
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="search-box">
                <span class="search-icon"><i class="fas fa-search"></i></span>
                <input type="text" class="search-input" id="customerSearch" placeholder="Search customers...">
            </div>

            <div class="section">
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>Name</th>
                                <th>Email</th>
                                <th>Phone</th>
                                <th>Total Orders</th>
                                <th>Total Spent</th>
                                <th>Last Purchase</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="customerTable">
                            <!-- Customer data will be added dynamically -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Analytics View -->
        <div class="view" id="analytics">
            <div class="header">
                <h2>Advanced Analytics</h2>
                <div class="header-actions">
                    <select style="padding: 0.5rem 1rem; border-radius: 8px; border: 1px solid var(--border); background: var(--bg-tertiary); color: var(--text-primary);">
                        <option>Last 7 days</option>
                        <option>Last 30 days</option>
                        <option>Last 3 months</option>
                        <option>Last year</option>
                    </select>
                </div>
            </div>

            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-header">
                        <div class="stat-icon">
                            <i class="fas fa-trending-up"></i>
                        </div>
                        <div>
                            <div class="stat-label">Growth Rate</div>
                            <div class="stat-value">23.5%</div>
                            <div class="stat-change positive">
                                <i class="fas fa-arrow-up"></i>
                                vs last period
                            </div>
                        </div>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-header">
                        <div class="stat-icon">
                            <i class="fas fa-clock"></i>
                        </div>
                        <div>
                            <div class="stat-label">Peak Hours</div>
                            <div class="stat-value">2-4 PM</div>
                            <div class="stat-change neutral">
                                <i class="fas fa-info-circle"></i>
                                Highest sales
                            </div>
                        </div>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-header">
                        <div class="stat-icon">
                            <i class="fas fa-tags"></i>
                        </div>
                        <div>
                            <div class="stat-label">Top Category</div>
                            <div class="stat-value">Electronics</div>
                            <div class="stat-change positive">
                                <i class="fas fa-arrow-up"></i>
                                45% of sales
                            </div>
                        </div>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-header">
                        <div class="stat-icon">
                            <i class="fas fa-map-marker-alt"></i>
                        </div>
                        <div>
                            <div class="stat-label">Top Store</div>
                            <div class="stat-value">Mall</div>
                            <div class="stat-change positive">
                                <i class="fas fa-arrow-up"></i>
                                ‚Çπ18,450 revenue
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="section">
                <div class="section-header">
                    <h3 class="section-title">Sales Trend</h3>
                </div>
                <div class="chart-container">
                    <canvas id="salesChart"></canvas>
                </div>
            </div>

            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 2rem;">
                <div class="section">
                    <div class="section-header">
                        <h3 class="section-title">Category Performance</h3>
                    </div>
                    <div class="chart-container">
                        <canvas id="categoryChart"></canvas>
                    </div>
                </div>

                <div class="section">
                    <div class="section-header">
                        <h3 class="section-title">Store Performance</h3>
                    </div>
                    <div class="chart-container">
                        <canvas id="storeChart"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <!-- Settings View -->
        <div class="view" id="settings">
            <div class="header">
                <h2>Settings</h2>
            </div>

            <div class="section">
                <h3 class="section-title">General Settings</h3>
                <div class="form-group">
                    <label class="form-label">Business Name</label>
                    <input type="text" class="form-input" value="RetailHub Inc.">
                </div>
                <div class="form-group">
                    <label class="form-label">Currency</label>
                    <select class="form-input">
                        <option value="INR" selected>INR (‚Çπ)</option>
                        <option value="USD">USD ($)</option>
                        <option value="EUR">EUR (‚Ç¨)</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">Tax Rate (%)</label>
                    <input type="number" class="form-input" value="18">
                </div>
                <div class="form-group">
                    <label class="form-label">UPI ID / VPA (For QR Payment)</label>
                    <input type="text" class="form-input" id="settingUpiId" placeholder="e.g. retailhub@upi">
                </div>
                <div class="form-group">
                    <label style="display: flex; align-items: center; gap: 0.75rem; cursor: pointer;">
                        <input type="checkbox" id="settingApplyTax" checked>
                        <span>Apply tax to orders (18%)</span>
                    </label>
                </div>
                <div class="form-group">
                    <label style="display: flex; align-items: center; gap: 0.75rem; cursor: pointer;">
                        <input type="checkbox" id="settingAutoPrint">
                        <span>Auto-print receipt after payment</span>
                    </label>
                </div>
                <button class="btn btn-primary" onclick="saveManualSettings()">Save Settings</button>
            </div>

            <div class="section" style="margin-top: 2rem;">
                <h3 class="section-title">Notifications</h3>
                <div class="form-group">
                    <label style="display: flex; align-items: center; gap: 0.75rem; cursor: pointer;">
                        <input type="checkbox" checked>
                        <span>Email alerts for low stock</span>
                    </label>
                </div>
                <div class="form-group">
                    <label style="display: flex; align-items: center; gap: 0.75rem; cursor: pointer;">
                        <input type="checkbox" checked>
                        <span>Daily sales summary</span>
                    </label>
                </div>
                <div class="form-group">
                    <label style="display: flex; align-items: center; gap: 0.75rem; cursor: pointer;">
                        <input type="checkbox">
                        <span>Weekly inventory report</span>
                    </label>
                </div>
            </div>
        </div>
    </div>

    <!-- Add Product Modal -->
    <div class="modal" id="addProductModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Add New Product</h3>
                <button class="close-btn" onclick="closeModal('addProductModal')">√ó</button>
            </div>
            <div class="form-group">
                <label class="form-label">Product Name</label>
                <input type="text" class="form-input" id="newProductName">
            </div>
            <div class="form-group">
                <label class="form-label">SKU</label>
                <input type="text" class="form-input" id="newProductSKU">
            </div>
            <div class="form-group">
                <label class="form-label">Category</label>
                <select class="form-input" id="newProductCategory">
                    <option>Electronics</option>
                    <option>Accessories</option>
                    <option>Clothing</option>
                    <option>Home & Garden</option>
                </select>
            </div>
            <div class="form-group">
                <label class="form-label">MRP (‚Çπ)</label>
                <input type="number" class="form-input" id="newProductMRP" step="0.01">
            </div>
            <div class="form-group">
                <label class="form-label">Cost Price (‚Çπ)</label>
                <input type="number" class="form-input" id="newProductCostPrice" step="0.01">
            </div>
            <div class="form-group">
                <label class="form-label">Selling Price (‚Çπ)</label>
                <input type="number" class="form-input" id="newProductSellingPrice" step="0.01">
            </div>
            <div class="form-group">
                <label class="form-label">Stock Quantity</label>
                <input type="number" class="form-input" id="newProductStock">
            </div>
            <div class="form-group">
                <label class="form-label">Store Location</label>
                <select class="form-input" id="newProductStore">
                    <option value="store1">Downtown Store</option>
                    <option value="store2">Mall Location</option>
                    <option value="store3">Airport Branch</option>
                </select>
            </div>
            <button class="btn btn-primary" onclick="addProduct()">Add Product</button>
        </div>
    </div>

    <!-- Quick Sale Modal -->
    <div class="modal" id="quickSaleModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Quick Sale</h3>
                <button class="close-btn" onclick="closeModal('quickSaleModal')">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="form-group">
                <label class="form-label">Product SKU or Name</label>
                <input type="text" class="form-input" id="quickSaleProduct" placeholder="Enter SKU or product name">
            </div>
            <div class="form-group">
                <label class="form-label">Quantity</label>
                <input type="number" class="form-input" id="quickSaleQuantity" value="1" min="1">
            </div>
            <div class="form-group">
                <label class="form-label">Customer (Optional)</label>
                <input type="text" class="form-input" id="quickSaleCustomer" placeholder="Customer name or phone">
            </div>
            <button class="btn btn-success" onclick="processQuickSale()">Process Sale</button>
        </div>
    </div>

    <!-- Customer Modal -->
    <div class="modal" id="customerModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Select Customer</h3>
                <button class="close-btn" onclick="closeModal('customerModal')">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="search-box" style="margin-bottom: 1rem;">
                <span class="search-icon"><i class="fas fa-search"></i></span>
                <input type="text" class="search-input" placeholder="Search customers...">
            </div>
            <div style="max-height: 300px; overflow-y: auto;">
                <div class="customer-option" onclick="selectCustomer('John Doe', 'john@example.com')">
                    <div style="font-weight: 600;">John Doe</div>
                    <div style="color: var(--text-secondary); font-size: 0.875rem;">john@example.com</div>
                </div>
                <div class="customer-option" onclick="selectCustomer('Jane Smith', 'jane@example.com')">
                    <div style="font-weight: 600;">Jane Smith</div>
                    <div style="color: var(--text-secondary); font-size: 0.875rem;">jane@example.com</div>
                </div>
                <div class="customer-option" onclick="selectCustomer('Walk-in Customer', '')">
                    <div style="font-weight: 600;">Walk-in Customer</div>
                    <div style="color: var(--text-secondary); font-size: 0.875rem;">No account</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Discount Modal -->
    <div class="modal" id="discountModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Apply Discount</h3>
                <button class="close-btn" onclick="closeModal('discountModal')">
                    <i class="fas fa-times"></i>
                </button>
            </div>

            <div class="tab-container" style="margin-bottom: 1.5rem;">
                <div class="tab active" onclick="switchDiscountTab('item', event)">Item Discount</div>
                <div class="tab" onclick="switchDiscountTab('cart', event)">Cart Discount</div>
                <div class="tab" onclick="switchDiscountTab('coupon', event)">Coupon Code</div>
            </div>

            <div id="itemDiscountTab" class="discount-tab active">
                <div class="form-group">
                    <label class="form-label">Select Item</label>
                    <select class="form-input" id="discountItemSelect">
                        <option value="">Choose an item...</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">Discount Type</label>
                    <select class="form-input" id="itemDiscountType">
                        <option value="percentage">Percentage (%)</option>
                        <option value="fixed">Fixed Amount (‚Çπ)</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">Discount Value</label>
                    <input type="number" class="form-input" id="itemDiscountValue" min="0" step="0.01">
                </div>
                <button class="btn btn-primary" onclick="applyItemDiscount()">Apply Item Discount</button>
            </div>

            <div id="cartDiscountTab" class="discount-tab">
                <div class="form-group">
                    <label class="form-label">Discount Type</label>
                    <select class="form-input" id="cartDiscountType">
                        <option value="percentage">Percentage (%)</option>
                        <option value="fixed">Fixed Amount (‚Çπ)</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">Discount Value</label>
                    <input type="number" class="form-input" id="cartDiscountValue" min="0" step="0.01">
                </div>
                <div class="form-group">
                    <label class="form-label">Reason (Optional)</label>
                    <input type="text" class="form-input" id="cartDiscountReason" placeholder="e.g., Employee discount, VIP customer">
                </div>
                <button class="btn btn-primary" onclick="applyCartDiscount()">Apply Cart Discount</button>
            </div>

            <div id="couponDiscountTab" class="discount-tab">
                <div class="form-group">
                    <label class="form-label">Coupon Code</label>
                    <input type="text" class="form-input" id="couponCode" placeholder="Enter coupon code" style="text-transform: uppercase;">
                </div>
                <button class="btn btn-primary" onclick="applyCouponDiscount()">Apply Coupon</button>
                <div style="margin-top: 1rem; font-size: 0.875rem; color: var(--text-secondary);">
                    Available coupons: SAVE10, WELCOME20, STUDENT15
                </div>
            </div>
        </div>
    </div>

    <!-- Payment Modal -->
    <div class="modal" id="paymentModal">
        <div class="modal-content" style="max-width: 500px;">
            <div class="modal-header">
                <h3 class="modal-title">Payment</h3>
                <button class="close-btn" onclick="closeModal('paymentModal')">
                    <i class="fas fa-times"></i>
                </button>
            </div>

            <div class="payment-summary" style="margin-bottom: 2rem; padding: 1rem; background: var(--bg-tertiary); border-radius: 8px;">
                <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
                    <span>Subtotal:</span>
                    <span id="paymentSubtotal">‚Çπ0</span>
                </div>
                <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
                    <span>Discount:</span>
                    <span id="paymentDiscount">-‚Çπ0</span>
                </div>
                <div id="paymentTaxRow" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem; gap: 1rem;">
                    <div style="display:flex; align-items:center; gap:0.5rem;">
                        <span style="font-weight:600;">Tax (18%):</span>
                    </div>
                    <div>
                        <span id="paymentTax">‚Çπ0</span>
                    </div>
                </div>
                <div style="display: flex; justify-content: space-between; font-weight: 700; font-size: 1.1em; border-top: 1px solid var(--border); padding-top: 0.5rem;">
                    <span>Total:</span>
                    <span id="paymentTotal">‚Çπ0</span>
                </div>
            </div>

            <div class="payment-methods">
                <div class="form-group">
                    <label class="form-label">Payment Method</label>
                    <div class="payment-options">
                        <button class="payment-option active" data-method="cash" onclick="selectPaymentMethod('cash', this)">
                            <i class="fas fa-money-bill-wave"></i>
                            Cash
                        </button>
                        <button class="payment-option" data-method="card" onclick="selectPaymentMethod('card', this)">
                            <i class="fas fa-credit-card"></i>
                            Card
                        </button>
                        <button class="payment-option" data-method="upi" onclick="selectPaymentMethod('upi', this)">
                            <i class="fas fa-qrcode"></i>
                            UPI / QR
                        </button>
                        <button class="payment-option" data-method="digital" onclick="selectPaymentMethod('digital', this)">
                            <i class="fas fa-mobile-alt"></i>
                            Digital
                        </button>
                        <button class="payment-option" data-method="split" onclick="selectPaymentMethod('split', this)">
                            <i class="fas fa-split"></i>
                            Split
                        </button>
                    </div>
                </div>

                <div id="cashPayment" class="payment-details active">
                    <div style="display: flex; justify-content: space-between; margin-bottom: 1rem;">
                        <span>Change:</span>
                        <span id="changeAmount">‚Çπ0</span>
                    </div>
                </div>

                <div id="upiPayment" class="payment-details">
                    <div style="text-align: center; padding: 1rem;">
                        <p style="margin-bottom: 1rem; color: var(--text-secondary);">Scan this QR code to pay via any UPI app</p>
                        <div id="upiQrCodeContainer" style="background: white; padding: 1rem; border-radius: 8px; display: inline-block; margin-bottom: 1rem;">
                            <img id="upiQrCode" src="" alt="UPI QR Code" style="width: 200px; height: 200px;">
                        </div>
                        <div style="margin-top: 1rem;">
                            <label class="form-label">Amount to Pay</label>
                            <div style="font-size: 1.5rem; font-weight: 700; color: var(--primary);" id="upiAmountDisplay">‚Çπ0</div>
                        </div>
                        <p style="margin-top: 0.5rem; font-size: 0.8rem; color: var(--text-muted);">
                            Google Pay, PhonePe, Paytm, BHIM, etc.
                        </p>
                    </div>
                </div>

                <div id="cardPayment" class="payment-details">
                    <div class="form-group">
                        <label class="form-label">Card Number</label>
                        <input type="text" class="form-input" id="cardNumber" placeholder="**** **** **** ****">
                    </div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                        <div class="form-group">
                            <label class="form-label">Expiry</label>
                            <input type="text" class="form-input" id="cardExpiry" placeholder="MM/YY">
                        </div>
                        <div class="form-group">
                            <label class="form-label">CVV</label>
                            <input type="text" class="form-input" id="cardCVV" placeholder="***">
                        </div>
                    </div>
                </div>

                <div id="digitalPayment" class="payment-details">
                    <div class="form-group">
                        <label class="form-label">Digital Wallet</label>
                        <select class="form-input" id="digitalWallet">
                            <option value="gpay">Google Pay</option>
                            <option value="phonepe">PhonePe</option>
                            <option value="paytm">Paytm</option>
                            <option value="amazonpay">Amazon Pay</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Transaction ID</label>
                        <input type="text" class="form-input" id="digitalTxnId" placeholder="Enter transaction ID">
                    </div>
                </div>

                <div id="splitPayment" class="payment-details">
                    <div id="splitPaymentsList">
                        <!-- Split payments will be added here -->
                    </div>
                    <button class="btn btn-outline" onclick="addSplitPayment()" style="width: 100%; margin-bottom: 1rem;">
                        <i class="fas fa-plus"></i>
                        Add Payment Method
                    </button>
                </div>
            </div>

            <div style="display: flex; gap: 0.5rem; margin-top: 2rem;">
                <button class="btn btn-success" onclick="processPayment()" style="flex: 1;">
                    <i class="fas fa-check"></i>
                    Complete Payment
                </button>
                <button class="btn btn-secondary" onclick="closeModal('paymentModal')">
                    Cancel
                </button>
            </div>
            <div id="checkoutSuccessActions" style="display: none; margin-top: 1rem;">
                <button class="btn btn-primary" onclick="printLastReceipt(); closeModal('paymentModal');" style="width: 100%;">
                    <i class="fas fa-print"></i>
                    Print Receipt
                </button>
            </div>
        </div>
    </div>

    <!-- Cart Options Modal -->
    <div class="modal" id="cartOptionsModal">
        <div class="modal-content" style="max-width: 400px;">
            <div class="modal-header">
                <h3 class="modal-title">Cart Options</h3>
                <button class="close-btn" onclick="closeModal('cartOptionsModal')">
                    <i class="fas fa-times"></i>
                </button>
            </div>

            <div style="display: flex; flex-direction: column; gap: 0.5rem;">
                <button class="btn btn-outline" onclick="clearCart(); closeModal('cartOptionsModal');">
                    <i class="fas fa-trash"></i>
                    Clear All Items
                </button>
                <button class="btn btn-outline" onclick="duplicateLastItem(); closeModal('cartOptionsModal');">
                    <i class="fas fa-copy"></i>
                    Duplicate Last Item
                </button>
                <button class="btn btn-outline" onclick="applyBulkDiscount(); closeModal('cartOptionsModal');">
                    <i class="fas fa-percent"></i>
                    Bulk Discount (10%)
                </button>
                <button class="btn btn-outline" onclick="saveCartAsPreset(); closeModal('cartOptionsModal');">
                    <i class="fas fa-save"></i>
                    Save as Preset
                </button>
                <button class="btn btn-outline" onclick="loadCartPreset(); closeModal('cartOptionsModal');">
                    <i class="fas fa-folder-open"></i>
                    Load Preset
                </button>
                <button class="btn btn-outline" onclick="printLastReceipt(); closeModal('cartOptionsModal');">
                    <i class="fas fa-print"></i>
                    Print Receipt
                </button>
            </div>
        </div>
    </div>

    <!-- Low Stock Modal -->
    <div class="modal" id="lowStockModal">
        <div class="modal-content" style="max-width: 800px;">
            <div class="modal-header">
                <h3 class="modal-title">Low Stock Alert</h3>
                <button class="close-btn" onclick="closeModal('lowStockModal')">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="table-container">
                <table>
                    <thead>
                        <tr>
                            <th>Product</th>
                            <th>Current Stock</th>
                            <th>Min. Required</th>
                            <th>Status</th>
                            <th>Action</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td>Premium Headphones</td>
                            <td>5</td>
                            <td>10</td>
                            <td><span class="badge badge-danger">Critical</span></td>
                            <td><button class="btn btn-primary" style="padding: 0.5rem 1rem;">Reorder</button></td>
                        </tr>
                        <tr>
                            <td>Wireless Mouse</td>
                            <td>8</td>
                            <td>15</td>
                            <td><span class="badge badge-warning">Low</span></td>
                            <td><button class="btn btn-primary" style="padding: 0.5rem 1rem;">Reorder</button></td>
                        </tr>
                        <tr>
                            <td>USB Cable</td>
                            <td>12</td>
                            <td>20</td>
                            <td><span class="badge badge-warning">Low</span></td>
                            <td><button class="btn btn-primary" style="padding: 0.5rem 1rem;">Reorder</button></td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Add Customer Modal -->
    <div class="modal" id="addCustomerModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Add New Customer</h3>
                <button class="close-btn" onclick="closeModal('addCustomerModal')">
                    <i class="fas fa-times"></i>
                </button>
            </div>

            <div>
                <div class="form-group">
                    <label for="newCustomerName">Full Name *</label>
                    <input type="text" class="form-input" id="newCustomerName" required placeholder="Enter customer name">
                </div>

                <div class="form-group">
                    <label for="newCustomerEmail">Email *</label>
                    <input type="email" class="form-input" id="newCustomerEmail" required placeholder="Enter email address">
                </div>

                <div class="form-group">
                    <label for="newCustomerPhone">Phone</label>
                    <input type="tel" class="form-input" id="newCustomerPhone" placeholder="Enter phone number">
                </div>

                <div class="form-group">
                    <label for="newCustomerAddress">Address</label>
                    <textarea class="form-input" id="newCustomerAddress" placeholder="Enter address" rows="3"></textarea>
                </div>

                <div style="display: flex; gap: 0.5rem; justify-content: flex-end;">
                    <button type="button" class="btn btn-secondary" onclick="closeModal('addCustomerModal')">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="addCustomer()">Add Customer</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ===== INDEXEDDB CONFIGURATION =====
        const DB_NAME = 'RetailHubDB';
        const DB_VERSION = 1;
        let db = null;
        let dbInitPromise = null;

        // Sample Products
        let products = [
            { id: 1, name: 'Premium Headphones', sku: 'HD-001', category: 'Electronics', mrp: 3499, costPrice: 2500, price: 2999, stock: 15, minStock: 10, image: 'üéß', store: 'store1' },
            { id: 2, name: 'Wireless Mouse', sku: 'MS-002', category: 'Accessories', mrp: 899, costPrice: 600, price: 799, stock: 25, minStock: 15, image: 'üñ±Ô∏è', store: 'store1' },
            { id: 3, name: 'USB-C Cable', sku: 'CB-003', category: 'Accessories', mrp: 349, costPrice: 200, price: 299, stock: 50, minStock: 20, image: 'üîå', store: 'store2' },
            { id: 4, name: 'Laptop Sleeve', sku: 'LS-004', category: 'Accessories', mrp: 999, costPrice: 700, price: 899, stock: 30, minStock: 15, image: 'üíº', store: 'store2' },
            { id: 5, name: 'Smart Watch', sku: 'SW-005', category: 'Electronics', mrp: 4499, costPrice: 3200, price: 3999, stock: 8, minStock: 10, image: '‚åö', store: 'store3' }
        ];

        // Sample Customers
        let customers = [
            { id: 1, name: 'John Doe', email: 'john@example.com', phone: '9876543210', totalOrders: 12, totalSpent: 45000, lastPurchase: '2026-02-10', status: 'VIP' },
            { id: 2, name: 'Jane Smith', email: 'jane@example.com', phone: '9876543211', totalOrders: 8, totalSpent: 32000, lastPurchase: '2026-02-09', status: 'Regular' },
            { id: 3, name: 'Mike Johnson', email: 'mike@example.com', phone: '9876543212', totalOrders: 3, totalSpent: 8900, lastPurchase: '2026-02-08', status: 'Regular' }
        ];

        // Global State
        let cart = [];
        let currentCustomer = null;
        let currentOrder = { items: [], discount: 0, type: 'retail' };
        let currentPayment = { method: 'cash', total: 0 };
        let lastCompletedOrder = null;
        let heldSales = [];
        let notifications = [];
        let charts = {};
        let editingProduct = null;

        // ===== INITIALIZE INDEXEDDB =====
        function initDB() {
            if (dbInitPromise) return dbInitPromise;
            
            dbInitPromise = new Promise((resolve, reject) => {
                const request = indexedDB.open(DB_NAME, DB_VERSION);

                request.onerror = () => {
                    console.error('IndexedDB initialization failed:', request.error);
                    reject(request.error);
                };
                
                request.onsuccess = () => {
                    db = request.result;
                    console.log('IndexedDB initialized successfully');
                    resolve(db);
                };

                request.onupgradeneeded = (event) => {
                    const db = event.target.result;

                    if (!db.objectStoreNames.contains('settings')) {
                        db.createObjectStore('settings', { keyPath: 'key' });
                    }
                    if (!db.objectStoreNames.contains('cart')) {
                        db.createObjectStore('cart', { keyPath: 'key' });
                    }
                    if (!db.objectStoreNames.contains('sales')) {
                        const salesStore = db.createObjectStore('sales', { keyPath: 'id', autoIncrement: true });
                        salesStore.createIndex('timestamp', 'timestamp', { unique: false });
                    }
                    if (!db.objectStoreNames.contains('savedOrders')) {
                        db.createObjectStore('savedOrders', { keyPath: 'id', autoIncrement: true });
                    }
                    if (!db.objectStoreNames.contains('cartPresets')) {
                        db.createObjectStore('cartPresets', { keyPath: 'id', autoIncrement: true });
                    }
                    if (!db.objectStoreNames.contains('products')) {
                        const productsStore = db.createObjectStore('products', { keyPath: 'id', autoIncrement: true });
                        productsStore.createIndex('name', 'name', { unique: false });
                        productsStore.createIndex('category', 'category', { unique: false });
                    }
                    if (!db.objectStoreNames.contains('customers')) {
                        const customersStore = db.createObjectStore('customers', { keyPath: 'id', autoIncrement: true });
                        customersStore.createIndex('email', 'email', { unique: false });
                    }
                };
            });
            
            return dbInitPromise;
        }

        // ===== INDEXEDDB HELPER FUNCTIONS =====
        async function dbGet(storeName, key) {
            try {
                if (!db) await initDB();
                return new Promise((resolve, reject) => {
                    const transaction = db.transaction([storeName], 'readonly');
                    const store = transaction.objectStore(storeName);
                    const request = store.get(key);

                    request.onsuccess = () => resolve(request.result?.value);
                    request.onerror = () => reject(request.error);
                });
            } catch (error) {
                console.error('dbGet error:', error);
                return undefined;
            }
        }

        async function dbSet(storeName, key, value) {
            try {
                if (!db) await initDB();
                return new Promise((resolve, reject) => {
                    const transaction = db.transaction([storeName], 'readwrite');
                    const store = transaction.objectStore(storeName);
                    const request = store.put({ key, value });

                    request.onsuccess = () => resolve(request.result);
                    request.onerror = () => reject(request.error);
                });
            } catch (error) {
                console.error('dbSet error:', error);
                throw error;
            }
        }

        async function dbGetAll(storeName) {
            try {
                if (!db) await initDB();
                return new Promise((resolve, reject) => {
                    const transaction = db.transaction([storeName], 'readonly');
                    const store = transaction.objectStore(storeName);
                    const request = store.getAll();

                    request.onsuccess = () => resolve(request.result || []);
                    request.onerror = () => reject(request.error);
                });
            } catch (error) {
                console.error('dbGetAll error:', error);
                return [];
            }
        }

        async function dbAdd(storeName, value) {
            try {
                if (!db) await initDB();
                return new Promise((resolve, reject) => {
                    const transaction = db.transaction([storeName], 'readwrite');
                    const store = transaction.objectStore(storeName);
                    const request = store.add(value);

                    request.onsuccess = () => resolve(request.result);
                    request.onerror = () => reject(request.error);
                });
            } catch (error) {
                console.error('dbAdd error:', error);
                throw error;
            }
        }

        async function dbUpdate(storeName, value) {
            try {
                if (!db) await initDB();
                return new Promise((resolve, reject) => {
                    const transaction = db.transaction([storeName], 'readwrite');
                    const store = transaction.objectStore(storeName);
                    const request = store.put(value);

                    request.onsuccess = () => resolve(request.result);
                    request.onerror = () => reject(request.error);
                });
            } catch (error) {
                console.error('dbUpdate error:', error);
                throw error;
            }
        }

        async function dbClear(storeName) {
            try {
                if (!db) await initDB();
                return new Promise((resolve, reject) => {
                    const transaction = db.transaction([storeName], 'readwrite');
                    const store = transaction.objectStore(storeName);
                    const request = store.clear();

                    request.onsuccess = () => resolve();
                    request.onerror = () => reject(request.error);
                });
            } catch (error) {
                console.error('dbClear error:', error);
                throw error;
            }
        }

        // ===== DATA INITIALIZATION =====
        async function initializeData() {
            try {
                // Check if products exist in DB
                const existingProducts = await dbGetAll('products');
                if (existingProducts.length === 0) {
                    // Save sample products to DB
                    for (const product of products) {
                        await dbAdd('products', product);
                    }
                } else {
                    // Load products from DB
                    products = existingProducts;
                }

                // Check if customers exist in DB
                const existingCustomers = await dbGetAll('customers');
                if (existingCustomers.length === 0) {
                    // Save sample customers to DB
                    for (const customer of customers) {
                        await dbAdd('customers', customer);
                    }
                } else {
                    // Load customers from DB
                    customers = existingCustomers;
                }
            } catch (error) {
                console.error('Failed to initialize data:', error);
            }
        }

        // ===== UTILITY FUNCTIONS =====
        function formatCurrency(value) {
            const num = Number(value) || 0;
            return '‚Çπ' + num.toFixed(2).replace(/\d(?=(\d{3})+\.)/g, '$&,');
        }

        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function getCategoryIcon(category) {
            const icons = {
                'Electronics': 'üì±',
                'Accessories': 'üéß',
                'Clothing': 'üëï',
                'Home & Garden': 'üè°'
            };
            return icons[category] || 'üì¶';
        }

        // ===== NOTIFICATION SYSTEM =====
        function showNotification(title, message, type = 'info') {
            const notification = {
                id: Date.now(),
                title,
                message,
                type,
                timestamp: new Date()
            };

            notifications.unshift(notification);
            renderNotifications();

            setTimeout(() => {
                removeNotification(notification.id);
            }, 5000);
        }

        function removeNotification(id) {
            notifications = notifications.filter(n => n.id !== id);
            renderNotifications();
        }

        function renderNotifications() {
            const container = document.getElementById('notificationContainer');
            if (!container) return;
            
            container.innerHTML = notifications.slice(0, 5).map(notification => {
                const icon = notification.type === 'success' ? 'check-circle' : 
                            notification.type === 'error' ? 'times-circle' : 
                            notification.type === 'warning' ? 'exclamation-triangle' : 'info-circle';
                
                return `
                    <div class="notification ${notification.type}">
                        <div class="notification-icon">
                            <i class="fas fa-${icon}"></i>
                        </div>
                        <div class="notification-content">
                            <div class="notification-title">${notification.title}</div>
                            <div class="notification-message">${notification.message}</div>
                        </div>
                        <button class="notification-close" onclick="removeNotification(${notification.id})">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                `;
            }).join('');
        }

        // ===== THEME MANAGEMENT =====
        function toggleTheme() {
            const root = document.body;
            const currentTheme = root.getAttribute('data-theme') || 'dark';
            const newTheme = currentTheme === 'light' ? 'dark' : 'light';

            root.setAttribute('data-theme', newTheme);
            dbSet('settings', 'theme', newTheme);

            const themeIcon = document.querySelector('.theme-toggle i');
            if (themeIcon) {
                themeIcon.className = newTheme === 'light' ? 'fas fa-moon' : 'fas fa-sun';
            }

            showNotification('Theme changed', `Switched to ${newTheme} mode`, 'info');
        }

        // ===== MOBILE MENU =====
        function toggleMobileMenu() {
            const sidebar = document.getElementById('sidebar');
            sidebar.classList.toggle('mobile-open');
        }

        // ===== NAVIGATION =====
        document.querySelectorAll('.nav-item').forEach(item => {
            item.addEventListener('click', async function() {
                const view = this.getAttribute('data-view');

                document.querySelectorAll('.nav-item').forEach(i => i.classList.remove('active'));
                this.classList.add('active');

                document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
                const viewEl = document.getElementById(view);
                if (viewEl) {
                    viewEl.classList.add('active');

                    if (view === 'analytics') {
                        await loadAnalytics();
                    } else if (view === 'customers') {
                        renderCustomers();
                    } else if (view === 'sales') {
                        loadSalesReports();
                    }
                }
            });
        });

        // ===== PRODUCT MANAGEMENT =====
        function renderProducts(filterCategory = 'all') {
            const grid = document.getElementById('productGrid');
            if (!grid) return;

            let filteredProducts = products;
            if (filterCategory !== 'all') {
                filteredProducts = products.filter(p => p.category === filterCategory);
            }

            grid.innerHTML = filteredProducts.map(product => {
                const stockStatus = product.stock <= product.minStock ? 'low-stock' : '';
                const isOutOfStock = product.stock === 0;
                const stockBadge = product.stock <= product.minStock ?
                    `<div class="product-stock">Low Stock: ${product.stock}</div>` :
                    `<div class="product-stock">Stock: ${product.stock}</div>`;

                return `
                    <div class="product-card ${stockStatus} ${isOutOfStock ? 'out-of-stock' : ''}" onclick="${isOutOfStock ? '' : `addToCart(${product.id})`}">
                        <div class="product-image">${product.image}</div>
                        <div class="product-name">${product.name}</div>
                        <div class="product-price">‚Çπ${product.price}</div>
                        ${stockBadge}
                    </div>
                `;
            }).join('');
        }

        function renderInventory() {
            const table = document.getElementById('inventoryTable');
            if (!table) return;

            table.innerHTML = products.map(product => {
                const stockPercentage = (product.stock / product.minStock) * 100;
                let stockStatus, stockText;

                if (product.stock === 0) {
                    stockStatus = 'badge-danger';
                    stockText = 'Out of Stock';
                } else if (stockPercentage <= 50) {
                    stockStatus = 'badge-danger';
                    stockText = 'Critical';
                } else if (stockPercentage <= 75) {
                    stockStatus = 'badge-warning';
                    stockText = 'Low Stock';
                } else {
                    stockStatus = 'badge-success';
                    stockText = 'In Stock';
                }

                return `
                    <tr>
                        <td>
                            <div style="display: flex; align-items: center; gap: 0.75rem;">
                                <span style="font-size: 1.25rem;">${product.image}</span>
                                <div>
                                    <div style="font-weight: 600;">${product.name}</div>
                                    <div style="color: var(--text-secondary); font-size: 0.875rem;">${product.sku}</div>
                                </div>
                            </div>
                        </td>
                        <td>${product.category}</td>
                        <td>${product.stock}</td>
                        <td>‚Çπ${product.mrp || 0}</td>
                        <td>‚Çπ${product.costPrice || 0}</td>
                        <td>‚Çπ${product.price}</td>
                        <td><span class="badge ${stockStatus}">${stockText}</span></td>
                        <td>
                            <button class="btn btn-secondary" style="padding: 0.5rem 1rem;" onclick="editProduct(${product.id})">
                                <i class="fas fa-edit"></i>
                            </button>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        function renderCustomers() {
            const table = document.getElementById('customerTable');
            if (!table) return;

            table.innerHTML = customers.map(customer => {
                const statusBadge = customer.status === 'VIP' ?
                    '<span class="badge badge-success">VIP</span>' :
                    '<span class="badge badge-info">Regular</span>';

                return `
                    <tr>
                        <td>${customer.name}</td>
                        <td>${customer.email}</td>
                        <td>${customer.phone}</td>
                        <td>${customer.totalOrders}</td>
                        <td>‚Çπ${customer.totalSpent.toLocaleString()}</td>
                        <td>${customer.lastPurchase || 'N/A'}</td>
                        <td>${statusBadge}</td>
                        <td>
                            <button class="btn btn-secondary" style="padding: 0.5rem;" onclick="viewCustomer(${customer.id})">
                                <i class="fas fa-eye"></i>
                            </button>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        async function addProduct() {
            const name = document.getElementById('newProductName')?.value;
            const sku = document.getElementById('newProductSKU')?.value;
            const category = document.getElementById('newProductCategory')?.value;
            const mrp = parseFloat(document.getElementById('newProductMRP')?.value) || 0;
            const costPrice = parseFloat(document.getElementById('newProductCostPrice')?.value) || 0;
            const price = parseFloat(document.getElementById('newProductSellingPrice')?.value);
            const stock = parseInt(document.getElementById('newProductStock')?.value);
            const store = document.getElementById('newProductStore')?.value;

            if (!name || !sku || !price || isNaN(price) || !stock || isNaN(stock)) {
                showNotification('Error', 'Please fill all required fields with valid values', 'error');
                return;
            }

            if (editingProduct) {
                // Update existing product
                editingProduct.name = name;
                editingProduct.sku = sku;
                editingProduct.category = category;
                editingProduct.mrp = mrp;
                editingProduct.costPrice = costPrice;
                editingProduct.price = price;
                editingProduct.stock = stock;
                editingProduct.store = store;
                editingProduct.image = getCategoryIcon(category);

                await dbUpdate('products', editingProduct);
                showNotification('Success', `${name} updated successfully`, 'success');
            } else {
                // Add new product
                const newProduct = {
                    id: Date.now(),
                    name,
                    sku,
                    category,
                    mrp,
                    costPrice,
                    price,
                    stock,
                    minStock: Math.max(5, Math.floor(stock * 0.2)),
                    image: getCategoryIcon(category),
                    store
                };

                products.push(newProduct);
                await dbAdd('products', newProduct);
                showNotification('Success', `${name} added to inventory`, 'success');
            }

            renderProducts();
            renderInventory();
            closeModal('addProductModal');
            clearProductForm();
            editingProduct = null;
        }

        function openAddProductModal() {
            editingProduct = null;
            clearProductForm();
            document.querySelector('#addProductModal .modal-title').textContent = 'Add New Product';
            document.querySelector('#addProductModal .btn-primary').textContent = 'Add Product';
            openModal('addProductModal');
        }

        function clearProductForm() {
            document.getElementById('newProductName').value = '';
            document.getElementById('newProductSKU').value = '';
            document.getElementById('newProductMRP').value = '';
            document.getElementById('newProductCostPrice').value = '';
            document.getElementById('newProductSellingPrice').value = '';
            document.getElementById('newProductStock').value = '';
        }

        async function addCustomer() {
            const name = document.getElementById('newCustomerName')?.value;
            const email = document.getElementById('newCustomerEmail')?.value;
            const phone = document.getElementById('newCustomerPhone')?.value;
            const address = document.getElementById('newCustomerAddress')?.value;

            if (!name || !email) {
                showNotification('Error', 'Name and email are required', 'error');
                return;
            }

            const newCustomer = {
                id: Date.now(),
                name,
                email,
                phone,
                address,
                totalOrders: 0,
                totalSpent: 0,
                lastPurchase: null,
                status: 'Regular'
            };

            customers.push(newCustomer);
            await dbAdd('customers', newCustomer);
            renderCustomers();
            closeModal('addCustomerModal');

            document.getElementById('newCustomerName').value = '';
            document.getElementById('newCustomerEmail').value = '';
            document.getElementById('newCustomerPhone').value = '';
            document.getElementById('newCustomerAddress').value = '';

            showNotification('Success', 'Customer added successfully', 'success');
        }

        // ===== CART MANAGEMENT =====
        function addToCart(productId) {
            const product = products.find(p => p.id === productId);
            if (!product || product.stock === 0) return;

            const existingItem = cart.find(item => item.id === productId);

            if (existingItem) {
                if (existingItem.quantity >= product.stock) {
                    showNotification('Stock Limit', `Only ${product.stock} units available`, 'warning');
                    return;
                }
                existingItem.quantity++;
            } else {
                cart.push({ ...product, quantity: 1 });
            }

            currentOrder.items = [...cart];
            renderCart();
            showNotification('Added to Cart', `${product.name} added successfully`, 'success');
        }

        function renderCart() {
            const cartItemsDiv = document.getElementById('cartItems');
            const cartTotalDiv = document.getElementById('cartTotal');
            const cartCount = document.getElementById('cartCount');

            if (!cartItemsDiv || !cartTotalDiv || !cartCount) return;

            cartCount.textContent = cart.reduce((sum, item) => sum + item.quantity, 0);

            if (cart.length === 0) {
                cartItemsDiv.innerHTML = `
                    <div style="text-align: center; color: var(--text-secondary); padding: 3rem 1rem;">
                        <i class="fas fa-shopping-cart" style="font-size: 3rem; margin-bottom: 1rem; opacity: 0.5;"></i>
                        <p>Cart is empty</p>
                        <small>Add products to start selling</small>
                    </div>
                `;
                cartTotalDiv.style.display = 'none';
                return;
            }

            cartItemsDiv.innerHTML = cart.map(item => `
                <div class="cart-item">
                    <div class="cart-item-info">
                        <div class="cart-item-name">${item.name}</div>
                        <div class="cart-item-price">${formatCurrency(item.price)} each</div>
                        ${item.discount ? `<div class="cart-item-discount" style="color:var(--text-secondary); font-size:0.85rem;">Discount: -${formatCurrency(item.discount)}</div>` : ''}
                    </div>
                    <div class="cart-item-qty">
                        <button class="qty-btn" onclick="updateQuantity(${item.id}, -1)">-</button>
                        <span style="min-width: 30px; text-align: center; font-family: 'JetBrains Mono', monospace;">${item.quantity}</span>
                        <button class="qty-btn" onclick="updateQuantity(${item.id}, 1)">+</button>
                    </div>
                    <div style="font-weight: 700; font-family: 'JetBrains Mono', monospace;">${formatCurrency((item.price * item.quantity) - (item.discount || 0))}</div>
                </div>
            `).join('');

            const subtotal = cart.reduce((sum, item) => sum + (item.price * item.quantity), 0);
            const itemDiscounts = cart.reduce((sum, item) => sum + (item.discount || 0), 0);
            const applyTax = document.getElementById('settingApplyTax')?.checked || false;
            const tax = applyTax ? Math.round((subtotal - itemDiscounts) * 0.18) : 0;
            const total = subtotal - itemDiscounts + tax;

            document.getElementById('subtotalAmount').textContent = formatCurrency(subtotal);
            document.getElementById('taxAmount').textContent = formatCurrency(tax);
            document.getElementById('totalAmount').textContent = formatCurrency(total);
            
            const taxRow = document.querySelector('.total-row.tax');
            if (taxRow) taxRow.style.display = applyTax ? 'flex' : 'none';
            
            const discountRow = document.getElementById('discountRow');
            if (discountRow) {
                discountRow.style.display = itemDiscounts > 0 ? 'flex' : 'none';
                document.getElementById('discountAmount').textContent = `-${formatCurrency(itemDiscounts)}`;
            }
            
            cartTotalDiv.style.display = 'block';
        }

        function updateQuantity(productId, change) {
            const item = cart.find(i => i.id === productId);
            if (!item) return;

            item.quantity += change;
            if (item.quantity <= 0) {
                cart = cart.filter(i => i.id !== productId);
            }
            currentOrder.items = [...cart];
            renderCart();
        }

        function clearCart() {
            if (cart.length === 0) return;
            if (confirm('Are you sure you want to clear the cart?')) {
                cart = [];
                currentOrder.items = [];
                currentOrder.discount = 0;
                renderCart();
                showNotification('Cart Cleared', 'All items removed from cart', 'info');
            }
        }

        function holdSale() {
            if (cart.length === 0) return;

            const heldSale = {
                id: Date.now(),
                items: [...cart],
                customer: currentCustomer,
                timestamp: new Date(),
                total: cart.reduce((sum, item) => sum + (item.price * item.quantity), 0)
            };

            heldSales.push(heldSale);
            cart = [];
            currentOrder.items = [];
            currentCustomer = null;
            renderCart();
            showNotification('Sale Held', 'Current sale has been held', 'info');
        }

        // ===== ORDER TYPE =====
        function selectOrderType(type, event) {
            const buttons = document.querySelectorAll('.order-type-btn');
            buttons.forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
            currentOrder.type = type;
            showNotification(`Order type set to ${type}`, 'success');
        }

        // ===== QUANTITY PRESET =====
        function addQuantityPreset(quantity) {
            const currentItem = cart[cart.length - 1];
            if (currentItem) {
                currentItem.quantity = quantity;
                renderCart();
                showNotification(`Quantity set to ${quantity}`, 'success');
            }
        }

        // ===== DISCOUNT FUNCTIONS =====
        function openDiscountModal() {
            openModal('discountModal');
            switchDiscountTab('item', { target: document.querySelector('.tab') });
            
            const itemSelect = document.getElementById('discountItemSelect');
            itemSelect.innerHTML = '<option value="">Choose an item...</option>' + 
                cart.map(item => `<option value="${item.id}">${item.name} (x${item.quantity})</option>`).join('');
        }

        function switchDiscountTab(tab, event) {
            const tabs = document.querySelectorAll('.discount-tab');
            const buttons = document.querySelectorAll('.tab');
            tabs.forEach(t => t.classList.remove('active'));
            buttons.forEach(btn => btn.classList.remove('active'));
            
            document.getElementById(`${tab}DiscountTab`).classList.add('active');
            event.target.classList.add('active');
        }

        function applyItemDiscount() {
            const itemId = document.getElementById('discountItemSelect')?.value;
            const discountType = document.getElementById('itemDiscountType')?.value;
            const discountValue = parseFloat(document.getElementById('itemDiscountValue')?.value);

            if (!itemId || !discountValue) {
                showNotification('Please select an item and enter discount value', 'error');
                return;
            }

            const item = cart.find(item => item.id == itemId);
            if (item) {
                const discount = discountType === 'percentage' 
                    ? (item.price * item.quantity * discountValue) / 100
                    : discountValue;
                
                item.discount = discount;
                renderCart();
                closeModal('discountModal');
                showNotification('Item discount applied', 'success');
            }
        }

        function applyCartDiscount() {
            const discountType = document.getElementById('cartDiscountType')?.value;
            const discountValue = parseFloat(document.getElementById('cartDiscountValue')?.value);

            if (!discountValue) {
                showNotification('Please enter discount value', 'error');
                return;
            }

            const subtotal = cart.reduce((sum, item) => sum + (item.price * item.quantity), 0);
            if (discountType === 'percentage') {
                currentOrder.discount = (subtotal * discountValue) / 100;
            } else {
                currentOrder.discount = discountValue;
            }
            
            renderCart();
            closeModal('discountModal');
            showNotification('Cart discount applied', 'success');
        }

        function applyCouponDiscount() {
            const couponCode = document.getElementById('couponCode')?.value.toUpperCase();
            const validCoupons = {
                'SAVE10': { type: 'percentage', value: 10 },
                'WELCOME20': { type: 'percentage', value: 20 },
                'STUDENT15': { type: 'percentage', value: 15 }
            };

            if (validCoupons[couponCode]) {
                const coupon = validCoupons[couponCode];
                const subtotal = cart.reduce((sum, item) => sum + (item.price * item.quantity), 0);
                currentOrder.discount = (subtotal * coupon.value) / 100;
                renderCart();
                closeModal('discountModal');
                showNotification(`Coupon ${couponCode} applied!`, 'success');
            } else {
                showNotification('Invalid coupon code', 'error');
            }
        }

        // ===== PAYMENT FUNCTIONS =====
        function openPaymentModal() {
            updatePaymentSummary();
            openModal('paymentModal');
            
            document.getElementById('changeAmount').textContent = formatCurrency(0);
            
            // Reset payment buttons for new checkout
            const successBtn = document.querySelector('#paymentModal .btn-success');
            const cancelBtn = document.querySelector('#paymentModal .btn-secondary');
            const successActions = document.getElementById('checkoutSuccessActions');
            if (successBtn) successBtn.style.display = 'flex';
            if (cancelBtn) cancelBtn.style.display = 'flex';
            if (successActions) successActions.style.display = 'none';
            
            const cashButton = document.querySelector('.payment-option[data-method="cash"]');
            selectPaymentMethod('cash', cashButton);
        }

        function selectPaymentMethod(method, button) {
            const options = document.querySelectorAll('.payment-option');
            options.forEach(opt => opt.classList.remove('active'));
            button.classList.add('active');

            const details = document.querySelectorAll('.payment-details');
            details.forEach(d => d.classList.remove('active'));
            
            const targetDetail = document.getElementById(`${method}Payment`);
            if (targetDetail) {
                targetDetail.classList.add('active');
            }

            currentPayment.method = method;

            if (method === 'upi') {
                const total = calculateTotal();
                const upiAmountDisplay = document.getElementById('upiAmountDisplay');
                if (upiAmountDisplay) upiAmountDisplay.textContent = formatCurrency(total);
                
                const upiId = document.getElementById('settingUpiId')?.value || "retailhub@upi";
                const upiName = "RetailHub Store";
                const amount = total.toFixed(2);
                const upiLink = `upi://pay?pa=${upiId}&pn=${encodeURIComponent(upiName)}&am=${amount}&cu=INR`;
                
                const qrImage = document.getElementById('upiQrCode');
                if (qrImage) {
                    qrImage.src = `https://api.qrserver.com/v1/create-qr-code/?size=200x200&data=${encodeURIComponent(upiLink)}`;
                }
            }
        }

        function updatePaymentSummary() {
            const subtotal = cart.reduce((sum, item) => sum + (item.price * item.quantity), 0);
            const itemDiscounts = cart.reduce((sum, item) => sum + (item.discount || 0), 0);
            const discount = (currentOrder.discount || 0) + itemDiscounts;
            const applyTax = document.getElementById('settingApplyTax')?.checked || false;
            const taxableAmount = Math.max(0, subtotal - discount);
            const tax = applyTax ? (taxableAmount * 0.18) : 0;
            const total = taxableAmount + tax;

            document.getElementById('paymentSubtotal').textContent = formatCurrency(subtotal);
            document.getElementById('paymentDiscount').textContent = `-${formatCurrency(discount)}`;
            document.getElementById('paymentTax').textContent = formatCurrency(tax);
            document.getElementById('paymentTotal').textContent = formatCurrency(total);

            const paymentTaxRow = document.getElementById('paymentTaxRow');
            if (paymentTaxRow) paymentTaxRow.style.display = applyTax ? 'flex' : 'none';

            currentPayment.total = total;
        }

        function calculateTotal() {
            const subtotal = cart.reduce((sum, item) => sum + (item.price * item.quantity), 0);
            const itemDiscounts = cart.reduce((sum, item) => sum + (item.discount || 0), 0);
            const discount = (currentOrder.discount || 0) + itemDiscounts;
            const applyTax = document.getElementById('settingApplyTax')?.checked || false;
            const taxableAmount = Math.max(0, subtotal - discount);
            const tax = applyTax ? (taxableAmount * 0.18) : 0;
            return taxableAmount + tax;
        }

        function processPayment() {
            const method = currentPayment.method;
            const amount = currentPayment.total || calculateTotal();
            const expectedTotal = currentPayment.total || calculateTotal();

            if (method === 'card') {
                const cardNumber = document.getElementById('cardNumber')?.value || '';
                if (cardNumber.replace(/\s+/g, '').length < 12) {
                    showNotification('Please enter a valid card number', 'error');
                    return;
                }
            }

            if (method === 'digital') {
                const txn = document.getElementById('digitalTxnId')?.value || '';
                if (!txn) {
                    showNotification('Please enter transaction ID for digital payment', 'error');
                    return;
                }
            }

            // Hide payment buttons and show print button
            document.querySelector('#paymentModal .btn-success').style.display = 'none';
            document.querySelector('#paymentModal .btn-secondary').style.display = 'none';
            document.getElementById('checkoutSuccessActions').style.display = 'block';
            
            showNotification('Payment successful!', 'success');
            
            completeOrder();
        }

        async function completeOrder() {
            const subtotal = cart.reduce((sum, item) => sum + (item.price * item.quantity), 0);
            const itemDiscounts = cart.reduce((sum, item) => sum + (item.discount || 0), 0);
            const discount = (currentOrder.discount || 0) + itemDiscounts;
            const applyTax = document.getElementById('settingApplyTax')?.checked || false;
            const taxableAmount = Math.max(0, subtotal - discount);
            const tax = applyTax ? (taxableAmount * 0.18) : 0;
            const total = taxableAmount + tax;

            const order = {
                id: Date.now(),
                items: [...cart],
                discount: discount,
                type: currentOrder.type,
                total: total,
                paymentMethod: currentPayment.method,
                timestamp: new Date().toISOString(),
                customer: currentCustomer,
                storeName: 'RetailHub',
                storeLocation: 'Store Location',
                cashier: 'Admin'
            };

            await dbAdd('sales', order);

            // Update customer stats if customer exists
            if (currentCustomer) {
                const customer = customers.find(c => c.id === currentCustomer.id);
                if (customer) {
                    customer.totalOrders += 1;
                    customer.totalSpent += total;
                    customer.lastPurchase = new Date().toISOString().split('T')[0];
                    await dbUpdate('customers', customer);
                }
            }

            for (const item of order.items) {
                const product = products.find(p => p.id === item.id);
                if (product) {
                    product.stock -= item.quantity;
                    await dbUpdate('products', product);
                }
            }

            const autoPrint = document.getElementById('settingAutoPrint')?.checked || false;
            if (autoPrint) {
                setTimeout(() => safePrintReceiptObject(order), 500);
            }

            // Store last completed order for printing
            lastCompletedOrder = order;

            cart = [];
            currentOrder = { items: [], discount: 0, type: 'retail' };
            currentPayment = { method: 'cash', total: 0 };
            currentCustomer = null;

            renderCart();
            renderProducts();
            renderInventory();
            loadDashboardStats();

            showNotification('Order completed successfully!', 'success');
        }

        // ===== RECEIPT PRINTING =====
        function printReceiptObject(receipt) {
            if (!receipt || !Array.isArray(receipt.items) || receipt.items.length === 0) {
                console.warn('Invalid receipt data');
                return false;
            }

            try {
                const subtotal = receipt.items.reduce((s, i) => s + (i.price * i.quantity), 0);
                const discount = receipt.discount || 0;
                const taxableAmount = Math.max(0, subtotal - discount);
                const taxRate = 0.18;
                const tax = receipt.tax || (taxableAmount * taxRate);
                const total = receipt.total || (taxableAmount + tax);
                const orderId = receipt.id ? String(receipt.id).slice(-8) : '00000000';
                const orderDate = receipt.timestamp ? new Date(receipt.timestamp) : new Date();
                
                const receiptHTML = `
                <div class="thermal-receipt" style="font-family: 'Courier New', Courier, monospace; max-width: 300px; margin: 0 auto; color: #1a1a1a; padding: 15px; background: #fff;">
                    <!-- Store Header -->
                    <div style="text-align: center; margin-bottom: 15px; padding-bottom: 10px; border-bottom: 2px solid #333;">
                        <div style="font-size: 28px; font-weight: bold; margin-bottom: 3px;">
                            <span style="color: #6366f1;">‚óè</span> ${escapeHtml(receipt.storeName || 'RetailHub')} <span style="color: #6366f1;">‚óè</span>
                        </div>
                        <p style="margin: 3px 0; font-size: 11px;">${escapeHtml(receipt.storeLocation || 'Your Store Address Here')}</p>
                        <p style="margin: 3px 0; font-size: 11px;">Phone: +1 234 567 8900 | Email: info@retailhub.com</p>
                        <p style="margin: 3px 0; font-size: 11px;">GSTIN: 12ABCDE3456F1Z5</p>
                    </div>

                    <!-- Order Info -->
                    <div style="background: #f5f5f5; padding: 8px; border-radius: 4px; margin-bottom: 15px;">
                        <table style="width: 100%; font-size: 11px;">
                            <tr>
                                <td style="padding: 2px 0;"><strong>Invoice No:</strong></td>
                                <td style="text-align: right;">${orderId}</td>
                            </tr>
                            <tr>
                                <td style="padding: 2px 0;"><strong>Date:</strong></td>
                                <td style="text-align: right;">${orderDate.toLocaleDateString('en-GB')}</td>
                            </tr>
                            <tr>
                                <td style="padding: 2px 0;"><strong>Time:</strong></td>
                                <td style="text-align: right;">${orderDate.toLocaleTimeString('en-GB', {hour: '2-digit', minute: '2-digit'})}</td>
                            </tr>
                            <tr>
                                <td style="padding: 2px 0;"><strong>Cashier:</strong></td>
                                <td style="text-align: right;">${escapeHtml(receipt.cashier || 'Admin')}</td>
                            </tr>
                            <tr>
                                <td style="padding: 2px 0;"><strong>Order Type:</strong></td>
                                <td style="text-align: right;">${escapeHtml((receipt.type || 'retail').toUpperCase())}</td>
                            </tr>
                        </table>
                    </div>

                    ${receipt.customer ? `
                    <!-- Customer Info -->
                    <div style="background: #e8f4fd; padding: 8px; border-radius: 4px; margin-bottom: 15px; border-left: 3px solid #3b82f6;">
                        <p style="margin: 0; font-size: 10px; color: #666;">CUSTOMER</p>
                        <p style="margin: 2px 0; font-size: 12px; font-weight: bold;">${escapeHtml(receipt.customer.name || 'Walk-in Customer')}</p>
                        ${receipt.customer.phone ? `<p style="margin: 0; font-size: 10px;">${escapeHtml(receipt.customer.phone)}</p>` : ''}
                        ${receipt.customer.email ? `<p style="margin: 0; font-size: 10px;">${escapeHtml(receipt.customer.email)}</p>` : ''}
                    </div>
                    ` : ''}

                    <!-- Divider -->
                    <div style="border-bottom: 1px dashed #999; margin-bottom: 10px;"></div>

                    <!-- Items Header -->
                    <table style="width: 100%; font-size: 11px; border-collapse: collapse; margin-bottom: 10px;">
                        <thead>
                            <tr style="border-bottom: 1px solid #333;">
                                <th style="text-align: left; padding: 4px 0; font-weight: bold;">Item</th>
                                <th style="text-align: center; padding: 4px 0; font-weight: bold; width: 35px;">Qty</th>
                                <th style="text-align: right; padding: 4px 0; font-weight: bold; width: 55px;">Rate</th>
                                <th style="text-align: right; padding: 4px 0; font-weight: bold; width: 55px;">Amount</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${receipt.items.map(item => `
                                <tr>
                                    <td style="padding: 4px 0; vertical-align: top;">
                                        <div style="font-weight: 500;">${escapeHtml(item.name || item.productName || 'Item')}</div>
                                        ${item.sku ? `<div style="font-size: 9px; color: #666;">SKU: ${escapeHtml(item.sku)}</div>` : ''}
                                        ${item.discount ? `<div style="font-size: 9px; color: #dc2626;">Disc: -${formatCurrency(item.discount)}</div>` : ''}
                                    </td>
                                    <td style="text-align: center; padding: 4px 0; vertical-align: top;">${escapeHtml(item.quantity)}</td>
                                    <td style="text-align: right; padding: 4px 0; vertical-align: top;">${formatCurrency(item.price)}</td>
                                    <td style="text-align: right; padding: 4px 0; vertical-align: top; font-weight: 500;">${formatCurrency((item.price * item.quantity) - (item.discount || 0))}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>

                    <!-- Divider -->
                    <div style="border-bottom: 1px dashed #999; margin-bottom: 10px;"></div>

                    <!-- Totals -->
                    <div style="margin-bottom: 15px;">
                        <div style="display: flex; justify-content: space-between; font-size: 11px; margin-bottom: 4px;">
                            <span>Subtotal</span>
                            <span>${formatCurrency(subtotal)}</span>
                        </div>
                        
                        ${discount > 0 ? `
                        <div style="display: flex; justify-content: space-between; font-size: 11px; margin-bottom: 4px; color: #dc2626;">
                            <span>Discount</span>
                            <span>-${formatCurrency(discount)}</span>
                        </div>
                        ` : ''}
                        
                        <div style="display: flex; justify-content: space-between; font-size: 11px; margin-bottom: 4px;">
                            <span>Tax (18%)</span>
                            <span>${formatCurrency(tax)}</span>
                        </div>
                        
                        <div style="display: flex; justify-content: space-between; font-size: 16px; font-weight: bold; margin-top: 8px; padding-top: 8px; border-top: 2px solid #333;">
                            <span>GRAND TOTAL</span>
                            <span>${formatCurrency(total)}</span>
                        </div>
                    </div>

                    <!-- Payment Info -->
                    <div style="background: #f5f5f5; padding: 10px; border-radius: 4px; margin-bottom: 15px;">
                        <div style="display: flex; justify-content: space-between; font-size: 11px; margin-bottom: 4px;">
                            <span><strong>Payment Method:</strong></span>
                            <span>${escapeHtml((receipt.paymentMethod || 'CASH').toString().toUpperCase())}</span>
                        </div>
                        <div style="display: flex; justify-content: space-between; font-size: 11px;">
                            <span><strong>Amount Paid:</strong></span>
                            <span>${formatCurrency(total)}</span>
                        </div>
                    </div>

                    <!-- Barcode -->
                    <div style="text-align: center; margin: 15px 0;">
                        <div style="border: 1px solid #333; padding: 5px; display: inline-block;">
                            <div style="font-family: 'Libre Barcode 39', cursive; font-size: 24px;">*${orderId}*</div>
                        </div>
                        <p style="margin: 3px 0; font-size: 10px;">${orderId}</p>
                    </div>

                    <!-- Footer -->
                    <div style="text-align: center; font-size: 11px; margin-top: 20px; padding-top: 15px; border-top: 1px dashed #999;">
                        <p style="margin: 5px 0; font-size: 14px; font-weight: bold;">‚òÖ‚òÖ‚òÖ THANK YOU ‚òÖ‚òÖ‚òÖ</p>
                        <p style="margin: 5px 0; font-size: 10px;">Please keep this receipt for warranty claims</p>
                        <p style="margin: 5px 0; font-size: 10px;">Goods once sold cannot be returned without receipt</p>
                        
                        <div style="margin-top: 15px; padding-top: 10px; border-top: 1px dotted #ccc;">
                            <p style="margin: 3px 0; font-size: 9px; color: #666;">-- CUSTOMER COPY --</p>
                            <p style="margin: 8px 0 3px 0; font-size: 9px;"><strong>RetailHub POS</strong> | www.retailhub.com</p>
                            <p style="margin: 0; font-size: 8px; color: #999;">Powered by RetailHub Solution</p>
                        </div>
                    </div>
                </div>
            `;

                const receiptContainer = document.getElementById('receipt-container');
                if (receiptContainer) {
                    receiptContainer.innerHTML = receiptHTML;
                    receiptContainer.style.display = 'block';
                    window.print();
                }
                return true;
            } catch (err) {
                console.error('Print error:', err);
                return false;
            }
        }

        function safePrintReceiptObject(receipt) {
            if (!receipt) return false;
            if (!Array.isArray(receipt.items)) {
                if (receipt.currentOrder && Array.isArray(receipt.currentOrder.items)) {
                    receipt.items = receipt.currentOrder.items;
                } else {
                    return false;
                }
            }
            if (receipt.items.length === 0) return false;
            return printReceiptObject(receipt);
        }

        async function printLastReceipt() {
            // Use lastCompletedOrder if available (from current checkout session)
            if (lastCompletedOrder) {
                safePrintReceiptObject(lastCompletedOrder);
                return;
            }
            // Otherwise, get from database
            const sales = await dbGetAll('sales');
            if (sales.length === 0) {
                showNotification('No receipts found', 'error');
                return;
            }
            const last = sales[sales.length - 1];
            safePrintReceiptObject(last);
        }

        // ===== SALES REPORTS =====
        async function loadSalesReports() {
            const period = document.getElementById('reportPeriod')?.value || 'month';
            const sales = await dbGetAll('sales');
            
            const filteredSales = filterSalesByPeriod(sales, period);
            const stats = calculateSalesStats(filteredSales);
            
            updateSalesStats(stats);
            updateTopProducts(filteredSales);
            updateRecentTransactions(filteredSales);
            updatePaymentMethodsBreakdown(filteredSales);
            loadSalesChart();
        }

        function filterSalesByPeriod(sales, period) {
            const now = new Date();
            const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
            
            return sales.filter(sale => {
                const saleDate = new Date(sale.timestamp);
                
                switch(period) {
                    case 'today':
                        return saleDate >= today;
                    case 'week':
                        const weekAgo = new Date(today);
                        weekAgo.setDate(weekAgo.getDate() - 7);
                        return saleDate >= weekAgo;
                    case 'month':
                        const monthAgo = new Date(today);
                        monthAgo.setMonth(monthAgo.getMonth() - 1);
                        return saleDate >= monthAgo;
                    case 'year':
                        const yearAgo = new Date(today);
                        yearAgo.setFullYear(yearAgo.getFullYear() - 1);
                        return saleDate >= yearAgo;
                    case 'all':
                    default:
                        return true;
                }
            });
        }

        function calculateSalesStats(sales) {
            const totalRevenue = sales.reduce((sum, sale) => sum + (sale.total || 0), 0);
            const totalTransactions = sales.length;
            const avgTransaction = totalTransactions > 0 ? totalRevenue / totalTransactions : 0;
            const totalItems = sales.reduce((sum, sale) => {
                return sum + (sale.items || []).reduce((itemSum, item) => itemSum + (item.quantity || 0), 0);
            }, 0);
            
            return { totalRevenue, totalTransactions, avgTransaction, totalItems };
        }

        function updateSalesStats(stats) {
            document.getElementById('totalRevenue').textContent = formatCurrency(stats.totalRevenue);
            document.getElementById('totalTransactions').textContent = stats.totalTransactions.toLocaleString();
            document.getElementById('avgTransaction').textContent = formatCurrency(stats.avgTransaction);
            document.getElementById('totalItems').textContent = stats.totalItems.toLocaleString();
        }

        function updateTopProducts(sales) {
            const productStats = {};
            
            sales.forEach(sale => {
                (sale.items || []).forEach(item => {
                    if (!productStats[item.name]) {
                        productStats[item.name] = {
                            name: item.name,
                            unitsSold: 0,
                            revenue: 0
                        };
                    }
                    productStats[item.name].unitsSold += item.quantity;
                    productStats[item.name].revenue += (item.price * item.quantity) - (item.discount || 0);
                });
            });
            
            const topProducts = Object.values(productStats)
                .sort((a, b) => b.revenue - a.revenue)
                .slice(0, 10);
            
            const table = document.getElementById('topProductsTable');
            document.getElementById('topProductsCount').textContent = `${topProducts.length} products`;
            
            if (topProducts.length === 0) {
                table.innerHTML = `
                    <tr>
                        <td colspan="4" style="text-align: center; padding: 2rem; color: var(--text-secondary);">
                            <i class="fas fa-shopping-bag" style="font-size: 2rem; margin-bottom: 1rem; opacity: 0.5; display: block;"></i>
                            No sales data yet. Start selling to see your top products!
                        </td>
                    </tr>
                `;
            } else {
                table.innerHTML = topProducts.map((product, index) => `
                    <tr>
                        <td>
                            <div style="display: flex; align-items: center; gap: 0.5rem;">
                                <span style="color: var(--text-muted); font-size: 0.875rem;">#${index + 1}</span>
                                <strong>${product.name}</strong>
                            </div>
                        </td>
                        <td>${product.unitsSold}</td>
                        <td><strong>${formatCurrency(product.revenue)}</strong></td>
                        <td>${formatCurrency(product.revenue / product.unitsSold)}</td>
                    </tr>
                `).join('');
            }
        }

        function updateRecentTransactions(sales) {
            const table = document.getElementById('recentTransactions');
            const recentSales = sales.slice(-50).reverse();
            
            if (recentSales.length === 0) {
                table.innerHTML = `
                    <tr>
                        <td colspan="7" style="text-align: center; padding: 2rem; color: var(--text-secondary);">
                            <i class="fas fa-receipt" style="font-size: 2rem; margin-bottom: 1rem; opacity: 0.5; display: block;"></i>
                            No transactions yet. Complete a sale to see it here!
                        </td>
                    </tr>
                `;
            } else {
                table.innerHTML = recentSales.map(sale => {
                    const date = new Date(sale.timestamp);
                    const itemCount = (sale.items || []).reduce((sum, item) => sum + item.quantity, 0);
                    const customerName = sale.customer?.name || 'Walk-in';
                    const paymentMethod = (sale.paymentMethod || 'cash').toUpperCase();
                    
                    return `
                        <tr>
                            <td><strong>INV-${sale.id}</strong></td>
                            <td>${date.toLocaleString()}</td>
                            <td>${itemCount} items</td>
                            <td>${customerName}</td>
                            <td><span class="badge badge-info">${paymentMethod}</span></td>
                            <td><strong>${formatCurrency(sale.total || 0)}</strong></td>
                            <td>
                                <button class="btn btn-secondary btn-sm" onclick="viewSaleDetails(${sale.id})" style="padding: 0.25rem 0.5rem;">
                                    <i class="fas fa-eye"></i>
                                </button>
                                <button class="btn btn-outline btn-sm" onclick="printSaleReceipt(${sale.id})" style="padding: 0.25rem 0.5rem;">
                                    <i class="fas fa-print"></i>
                                </button>
                            </td>
                        </tr>
                    `;
                }).join('');
            }
        }

        function updatePaymentMethodsBreakdown(sales) {
            const paymentStats = {};
            
            sales.forEach(sale => {
                const method = (sale.paymentMethod || 'cash').toLowerCase();
                if (!paymentStats[method]) {
                    paymentStats[method] = { count: 0, total: 0 };
                }
                paymentStats[method].count++;
                paymentStats[method].total += sale.total || 0;
            });
            
            const container = document.getElementById('paymentMethodsChart');
            
            if (Object.keys(paymentStats).length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 2rem; color: var(--text-secondary);">
                        <i class="fas fa-credit-card" style="font-size: 2rem; margin-bottom: 1rem; opacity: 0.5;"></i>
                        <p>No payment data</p>
                    </div>
                `;
            } else {
                container.innerHTML = Object.entries(paymentStats).map(([method, stats]) => {
                    const icon = method === 'cash' ? 'money-bill-wave' : method === 'card' ? 'credit-card' : 'mobile-alt';
                    return `
                        <div class="stat-card">
                            <div class="stat-header">
                                <div class="stat-icon">
                                    <i class="fas fa-${icon}"></i>
                                </div>
                                <div>
                                    <div class="stat-label">${method.charAt(0).toUpperCase() + method.slice(1)}</div>
                                    <div class="stat-value">${formatCurrency(stats.total)}</div>
                                    <div class="stat-change neutral">
                                        <i class="fas fa-receipt"></i>
                                        ${stats.count} transactions
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                }).join('');
            }
        }

        async function loadSalesChart() {
            // Wait for Chart.js to be ready
            try {
                await chartJsReady;
            } catch (error) {
                console.error('Chart.js not available:', error);
                return;
            }
            
            const chartType = document.getElementById('chartType')?.value || 'monthly';
            const sales = await dbGetAll('sales');
            
            const chartData = prepareSalesChartData(sales, chartType);
            
            const ctx = document.getElementById('salesTrendChart');
            if (!ctx) return;
            
            if (charts.salesTrendChart) {
                charts.salesTrendChart.destroy();
            }
            
            charts.salesTrendChart = new Chart(ctx.getContext('2d'), {
                type: 'line',
                data: {
                    labels: chartData.labels,
                    datasets: [{
                        label: 'Revenue',
                        data: chartData.data,
                        borderColor: '#6366f1',
                        backgroundColor: 'rgba(99, 102, 241, 0.1)',
                        tension: 0.4,
                        fill: true,
                        pointRadius: 4,
                        pointHoverRadius: 6
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return 'Revenue: ' + formatCurrency(context.parsed.y);
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return formatCurrency(value);
                                }
                            }
                        }
                    }
                }
            });
        }

        function prepareSalesChartData(sales, type) {
            const now = new Date();
            let labels = [];
            let data = [];
            
            if (type === 'daily') {
                for (let i = 6; i >= 0; i--) {
                    const date = new Date(now);
                    date.setDate(date.getDate() - i);
                    labels.push(date.toLocaleDateString('en-US', { weekday: 'short' }));
                    
                    const dayStart = new Date(date.getFullYear(), date.getMonth(), date.getDate());
                    const dayEnd = new Date(dayStart);
                    dayEnd.setDate(dayEnd.getDate() + 1);
                    
                    const daySales = sales.filter(sale => {
                        const saleDate = new Date(sale.timestamp);
                        return saleDate >= dayStart && saleDate < dayEnd;
                    });
                    
                    data.push(daySales.reduce((sum, sale) => sum + (sale.total || 0), 0));
                }
            } else if (type === 'weekly') {
                for (let i = 7; i >= 0; i--) {
                    const weekStart = new Date(now);
                    weekStart.setDate(weekStart.getDate() - (i * 7));
                    const weekEnd = new Date(weekStart);
                    weekEnd.setDate(weekEnd.getDate() + 7);
                    
                    labels.push(`Week ${8 - i}`);
                    
                    const weekSales = sales.filter(sale => {
                        const saleDate = new Date(sale.timestamp);
                        return saleDate >= weekStart && saleDate < weekEnd;
                    });
                    
                    data.push(weekSales.reduce((sum, sale) => sum + (sale.total || 0), 0));
                }
            } else {
                for (let i = 11; i >= 0; i--) {
                    const monthDate = new Date(now.getFullYear(), now.getMonth() - i, 1);
                    labels.push(monthDate.toLocaleDateString('en-US', { month: 'short' }));
                    
                    const monthStart = new Date(monthDate.getFullYear(), monthDate.getMonth(), 1);
                    const monthEnd = new Date(monthDate.getFullYear(), monthDate.getMonth() + 1, 1);
                    
                    const monthSales = sales.filter(sale => {
                        const saleDate = new Date(sale.timestamp);
                        return saleDate >= monthStart && saleDate < monthEnd;
                    });
                    
                    data.push(monthSales.reduce((sum, sale) => sum + (sale.total || 0), 0));
                }
            }
            
            return { labels, data };
        }

        async function exportSalesReport() {
            const period = document.getElementById('reportPeriod')?.value || 'month';
            const sales = await dbGetAll('sales');
            const filteredSales = filterSalesByPeriod(sales, period);
            
            if (filteredSales.length === 0) {
                showNotification('No data to export', 'No sales found for the selected period', 'warning');
                return;
            }
            
            let csv = 'Invoice,Date,Time,Customer,Items,Payment Method,Subtotal,Discount,Tax,Total\n';
            
            filteredSales.forEach(sale => {
                const date = new Date(sale.timestamp);
                const customer = sale.customer?.name || 'Walk-in';
                const itemCount = (sale.items || []).reduce((sum, item) => sum + item.quantity, 0);
                const subtotal = (sale.items || []).reduce((sum, item) => sum + (item.price * item.quantity), 0);
                const discount = sale.discount || 0;
                const tax = sale.total - subtotal + discount;
                
                csv += `INV-${sale.id},${date.toLocaleDateString()},${date.toLocaleTimeString()},${customer},${itemCount},${sale.paymentMethod || 'cash'},${subtotal},${discount},${tax},${sale.total}\n`;
            });
            
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `sales-report-${period}-${new Date().toISOString().split('T')[0]}.csv`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            showNotification('Export Complete', `Exported ${filteredSales.length} transactions to CSV`, 'success');
        }

        async function clearAllSales() {
            if (confirm('Are you sure you want to delete ALL sales data? This cannot be undone!')) {
                if (confirm('This will permanently delete all transaction history. Are you absolutely sure?')) {
                    await dbClear('sales');
                    showNotification('Sales Cleared', 'All sales data has been deleted', 'success');
                    loadSalesReports();
                }
            }
        }

        async function viewSaleDetails(saleId) {
            const sales = await dbGetAll('sales');
            const sale = sales.find(s => s.id === saleId);
            if (sale) {
                showNotification('Sale Details', `Order #${sale.id} - Total: ${formatCurrency(sale.total)}`, 'info');
            }
        }

        async function printSaleReceipt(saleId) {
            const sales = await dbGetAll('sales');
            const sale = sales.find(s => s.id === saleId);
            if (sale) {
                safePrintReceiptObject(sale);
            }
        }

        // ===== ANALYTICS =====
        async function loadAnalytics() {
            if (!document.getElementById('salesChart')) return;
            
            // Wait for Chart.js to be ready
            try {
                await chartJsReady;
            } catch (error) {
                console.error('Chart.js not available:', error);
                return;
            }
            
            const salesCtx = document.getElementById('salesChart').getContext('2d');
            charts.salesChart = new Chart(salesCtx, {
                type: 'line',
                data: {
                    labels: ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'],
                    datasets: [{
                        label: 'Sales',
                        data: [12000, 19000, 15000, 25000, 22000, 30000, 28000],
                        borderColor: '#6366f1',
                        backgroundColor: 'rgba(99, 102, 241, 0.1)',
                        tension: 0.4,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return '‚Çπ' + (value / 1000) + 'k';
                                }
                            }
                        }
                    }
                }
            });

            const categoryCtx = document.getElementById('categoryChart').getContext('2d');
            charts.categoryChart = new Chart(categoryCtx, {
                type: 'doughnut',
                data: {
                    labels: ['Electronics', 'Accessories', 'Clothing', 'Home & Garden'],
                    datasets: [{
                        data: [45, 25, 20, 10],
                        backgroundColor: ['#6366f1', '#8b5cf6', '#10b981', '#f59e0b']
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { position: 'bottom' } }
                }
            });

            const storeCtx = document.getElementById('storeChart').getContext('2d');
            charts.storeChart = new Chart(storeCtx, {
                type: 'bar',
                data: {
                    labels: ['Downtown', 'Mall', 'Airport'],
                    datasets: [{
                        label: 'Revenue',
                        data: [18450, 15230, 11551],
                        backgroundColor: '#6366f1',
                        borderRadius: 8
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return '‚Çπ' + (value / 1000) + 'k';
                                }
                            }
                        }
                    }
                }
            });
        }

        // ===== SEARCH FUNCTIONS =====
        document.getElementById('productSearch')?.addEventListener('input', function(e) {
            const search = e.target.value.toLowerCase();
            const filtered = products.filter(p =>
                p.name.toLowerCase().includes(search) ||
                p.category.toLowerCase().includes(search) ||
                p.sku.toLowerCase().includes(search)
            );

            const grid = document.getElementById('productGrid');
            grid.innerHTML = filtered.map(product => {
                const stockStatus = product.stock <= product.minStock ? 'low-stock' : '';
                const isOutOfStock = product.stock === 0;

                return `
                    <div class="product-card ${stockStatus} ${isOutOfStock ? 'out-of-stock' : ''}" onclick="${isOutOfStock ? '' : `addToCart(${product.id})`}">
                        <div class="product-image">${product.image}</div>
                        <div class="product-name">${product.name}</div>
                        <div class="product-price">‚Çπ${product.price}</div>
                        <div class="product-stock">Stock: ${product.stock}</div>
                    </div>
                `;
            }).join('');
        });

        document.getElementById('inventorySearch')?.addEventListener('input', function(e) {
            const search = e.target.value.toLowerCase();
            const filtered = products.filter(p =>
                p.name.toLowerCase().includes(search) ||
                p.sku.toLowerCase().includes(search) ||
                p.category.toLowerCase().includes(search)
            );

            const table = document.getElementById('inventoryTable');
            table.innerHTML = filtered.map(product => {
                const stockPercentage = (product.stock / product.minStock) * 100;
                let stockStatus, stockText;

                if (product.stock === 0) {
                    stockStatus = 'badge-danger';
                    stockText = 'Out of Stock';
                } else if (stockPercentage <= 50) {
                    stockStatus = 'badge-danger';
                    stockText = 'Critical';
                } else if (stockPercentage <= 75) {
                    stockStatus = 'badge-warning';
                    stockText = 'Low Stock';
                } else {
                    stockStatus = 'badge-success';
                    stockText = 'In Stock';
                }

                return `
                    <tr>
                        <td>
                            <div style="display: flex; align-items: center; gap: 0.75rem;">
                                <span style="font-size: 1.25rem;">${product.image}</span>
                                <div>
                                    <div style="font-weight: 600;">${product.name}</div>
                                    <div style="color: var(--text-secondary); font-size: 0.875rem;">${product.sku}</div>
                                </div>
                            </div>
                        </td>
                        <td>${product.category}</td>
                        <td>${product.stock}</td>
                        <td>‚Çπ${product.price}</td>
                        <td><span class="badge ${stockStatus}">${stockText}</span></td>
                        <td>
                            <button class="btn btn-secondary" style="padding: 0.5rem 1rem;" onclick="editProduct(${product.id})">
                                <i class="fas fa-edit"></i>
                            </button>
                        </td>
                    </tr>
                `;
            }).join('');
        });

        document.getElementById('customerSearch')?.addEventListener('input', function(e) {
            const search = e.target.value.toLowerCase();
            const filtered = customers.filter(c =>
                c.name.toLowerCase().includes(search) ||
                c.email.toLowerCase().includes(search) ||
                (c.phone && c.phone.includes(search))
            );

            const table = document.getElementById('customerTable');
            table.innerHTML = filtered.map(customer => {
                const statusBadge = customer.status === 'VIP' ?
                    '<span class="badge badge-success">VIP</span>' :
                    '<span class="badge badge-info">Regular</span>';

                return `
                    <tr>
                        <td>${customer.name}</td>
                        <td>${customer.email}</td>
                        <td>${customer.phone || 'N/A'}</td>
                        <td>${customer.totalOrders}</td>
                        <td>‚Çπ${customer.totalSpent.toLocaleString()}</td>
                        <td>${customer.lastPurchase || 'N/A'}</td>
                        <td>${statusBadge}</td>
                        <td>
                            <button class="btn btn-secondary" style="padding: 0.5rem;" onclick="viewCustomer(${customer.id})">
                                <i class="fas fa-eye"></i>
                            </button>
                        </td>
                    </tr>
                `;
            }).join('');
        });

        // ===== BARCODE SCANNING =====
        function scanBarcode() {
            showNotification('Barcode Scanner', 'Simulating barcode scan...', 'info');

            setTimeout(() => {
                if (products.length > 0) {
                    const randomProduct = products[Math.floor(Math.random() * products.length)];
                    addToCart(randomProduct.id);
                    showNotification('Product Scanned', `${randomProduct.name} added via barcode`, 'success');
                }
            }, 1500);
        }

        // ===== KEYBOARD SHORTCUTS =====
        document.addEventListener('keydown', function(e) {
            if (e.key === 'F2') {
                e.preventDefault();
                scanBarcode();
            }

            if (e.ctrlKey && e.key === 'Enter') {
                e.preventDefault();
                if (cart.length > 0) {
                    openPaymentModal();
                }
            }

            if (e.key === 'Escape') {
                if (cart.length > 0 && confirm('Clear cart?')) {
                    clearCart();
                }
            }
        });

        // ===== CATEGORY TABS =====
        document.querySelectorAll('.tab[data-category]').forEach(tab => {
            tab.addEventListener('click', function() {
                const category = this.getAttribute('data-category');

                document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                this.classList.add('active');

                renderProducts(category);
            });
        });

        // ===== MODAL FUNCTIONS =====
        function openModal(modalId) {
            const modal = document.getElementById(modalId);
            if (modal) modal.classList.add('active');
        }

        function closeModal(modalId) {
            const modal = document.getElementById(modalId);
            if (modal) modal.classList.remove('active');
        }

        document.addEventListener('click', function(e) {
            if (e.target.classList.contains('modal')) {
                e.target.classList.remove('active');
            }
        });

        // ===== CUSTOMER FUNCTIONS =====
        function selectCustomer(name, email) {
            currentCustomer = { name, email };
            closeModal('customerModal');
            showNotification('Customer Selected', `${name} selected for this sale`, 'info');
        }

        // ===== QUICK SALE =====
        function processQuickSale() {
            const productInput = document.getElementById('quickSaleProduct')?.value;
            const quantity = parseInt(document.getElementById('quickSaleQuantity')?.value);
            const customer = document.getElementById('quickSaleCustomer')?.value;

            if (!productInput || !quantity) {
                showNotification('Error', 'Please enter product and quantity', 'error');
                return;
            }

            const product = products.find(p =>
                p.name.toLowerCase().includes(productInput.toLowerCase()) ||
                p.sku.toLowerCase().includes(productInput.toLowerCase())
            );

            if (!product) {
                showNotification('Error', 'Product not found', 'error');
                return;
            }

            if (quantity > product.stock) {
                showNotification('Error', 'Insufficient stock', 'error');
                return;
            }

            for (let i = 0; i < quantity; i++) {
                addToCart(product.id);
            }

            if (customer) {
                currentCustomer = { name: customer, email: '' };
            }

            closeModal('quickSaleModal');
            setTimeout(() => openPaymentModal(), 500);
        }

        // ===== RECENT SALES =====
        async function loadRecentSales() {
            const sales = await dbGetAll('sales');
            const recentSales = sales.slice(-10).reverse();

            const salesList = document.getElementById('recentSalesList');
            if (!salesList) return;

            if (recentSales.length === 0) {
                salesList.innerHTML = '<p style="text-align: center; color: var(--text-secondary); padding: 2rem;">No recent sales found</p>';
                return;
            }

            salesList.innerHTML = recentSales.map(sale => `
                <div class="recent-sale-item" onclick="printSaleReceipt(${sale.id})">
                    <div class="recent-sale-header">
                        <span class="recent-sale-id">#${sale.id}</span>
                        <span class="recent-sale-time">${new Date(sale.timestamp).toLocaleTimeString()}</span>
                    </div>
                    <div class="recent-sale-customer">${sale.customer?.name || 'Walk-in'}</div>
                    <div class="recent-sale-total">${formatCurrency(sale.total || 0)}</div>
                </div>
            `).join('');
        }

        // ===== CART OPTIONS =====
        function duplicateLastItem() {
            if (cart.length > 0) {
                const lastItem = cart[cart.length - 1];
                const duplicatedItem = { ...lastItem };
                cart.push(duplicatedItem);
                renderCart();
                showNotification('Item duplicated', 'success');
            } else {
                showNotification('No items to duplicate', 'error');
            }
        }

        function applyBulkDiscount() {
            if (cart.length > 0) {
                const subtotal = cart.reduce((sum, item) => sum + (item.price * item.quantity), 0);
                currentOrder.discount = subtotal * 0.1;
                renderCart();
                showNotification('10% bulk discount applied', 'success');
            } else {
                showNotification('No items in cart', 'error');
            }
        }

        async function saveCartAsPreset() {
            if (cart.length > 0) {
                const presetName = prompt('Enter preset name:');
                if (presetName) {
                    const preset = {
                        name: presetName,
                        items: [...cart],
                        timestamp: new Date().toISOString()
                    };
                    await dbAdd('cartPresets', preset);
                    showNotification(`Preset "${presetName}" saved`, 'success');
                }
            } else {
                showNotification('Cart is empty', 'error');
            }
        }

        async function loadCartPreset() {
            const presets = await dbGetAll('cartPresets');
            if (presets.length > 0) {
                const presetNames = presets.map((p, i) => `${i + 1}. ${p.name}`).join('\n');
                const choice = prompt(`Available presets:\n${presetNames}\n\nEnter preset number:`);
                const index = parseInt(choice) - 1;
                if (index >= 0 && index < presets.length) {
                    cart = [...presets[index].items];
                    currentOrder.items = [...cart];
                    renderCart();
                    showNotification(`Preset "${presets[index].name}" loaded`, 'success');
                } else {
                    showNotification('Invalid preset number', 'error');
                }
            } else {
                showNotification('No presets available', 'error');
            }
        }

        // ===== SETTINGS =====
        async function saveManualSettings() {
            try {
                const autoPrint = document.getElementById('settingAutoPrint')?.checked || false;
                const applyTax = document.getElementById('settingApplyTax')?.checked || false;
                const upiId = document.getElementById('settingUpiId')?.value || '';
                
                await dbSet('settings', 'settingAutoPrint', autoPrint ? 'true' : 'false');
                await dbSet('settings', 'settingApplyTax', applyTax ? 'true' : 'false');
                await dbSet('settings', 'settingUpiId', upiId);
                
                showNotification('Settings saved successfully', 'success');
            } catch (e) {
                showNotification('Failed to save settings', 'error');
                console.error('Save settings error:', e);
            }
        }

        async function loadSettings() {
            try {
                const auto = await dbGet('settings', 'settingAutoPrint');
                const el = document.getElementById('settingAutoPrint');
                if (el && auto !== undefined) el.checked = (auto === 'true');
                
                const apply = await dbGet('settings', 'settingApplyTax');
                const taxEl = document.getElementById('settingApplyTax');
                if (taxEl && apply !== undefined) taxEl.checked = (apply === 'true');

                const upiId = await dbGet('settings', 'settingUpiId');
                const upiEl = document.getElementById('settingUpiId');
                if (upiEl && upiId) upiEl.value = upiId;
            } catch (e) {
                console.error('Failed to load settings:', e);
            }
        }

        // ===== SPLIT PAYMENT (PLACEHOLDER) =====
        function addSplitPayment() {
            showNotification('Split payments coming soon', 'info');
        }

        async function loadDashboardStats() {
            const sales = await dbGetAll('sales');
            const today = new Date();
            const todayString = today.toISOString().split('T')[0];
            
            // Today's sales
            const todaySales = sales.filter(sale => {
                const saleDate = new Date(sale.timestamp).toISOString().split('T')[0];
                return saleDate === todayString;
            });
            const todayRevenue = todaySales.reduce((sum, sale) => sum + (sale.total || 0), 0);
            
            // Total inventory
            const totalInventory = products.reduce((sum, product) => sum + (product.stock || 0), 0);
            
            // Low stock items
            const lowStockItems = products.filter(product => product.stock <= product.minStock).length;
            
            // Monthly revenue (current month)
            const currentMonth = today.getMonth();
            const currentYear = today.getFullYear();
            const monthlySales = sales.filter(sale => {
                const saleDate = new Date(sale.timestamp);
                return saleDate.getMonth() === currentMonth && saleDate.getFullYear() === currentYear;
            });
            const monthlyRevenue = monthlySales.reduce((sum, sale) => sum + (sale.total || 0), 0);
            
            // Low stock alerts
            const outOfStock = products.filter(product => product.stock === 0).length;
            const lowStock = products.filter(product => product.stock > 0 && product.stock <= product.minStock).length;
            
            // Calculate total stats
            const totalRevenue = sales.reduce((sum, sale) => sum + (sale.total || 0), 0);
            const totalTransactions = sales.length;
            const avgTransaction = totalTransactions > 0 ? totalRevenue / totalTransactions : 0;
            const totalItems = sales.reduce((sum, sale) => sum + (sale.items || []).reduce((itemSum, item) => itemSum + item.quantity, 0), 0);
            
            // Update Dashboard stat cards (Dashboard view IDs)
            const todaySalesEl = document.getElementById('todaySales');
            const totalInventoryEl = document.getElementById('totalInventory');
            const lowStockItemsEl = document.getElementById('lowStockItems');
            const monthlyRevenueEl = document.getElementById('monthlyRevenue');
            
            if (todaySalesEl) todaySalesEl.textContent = formatCurrency(todayRevenue);
            if (totalInventoryEl) totalInventoryEl.textContent = totalInventory.toLocaleString();
            if (lowStockItemsEl) lowStockItemsEl.textContent = lowStockItems.toLocaleString();
            if (monthlyRevenueEl) monthlyRevenueEl.textContent = formatCurrency(monthlyRevenue);
            
            // Also update Sales Reports stat cards (if visible)
            const totalRevenueEl = document.getElementById('totalRevenue');
            const totalTransactionsEl = document.getElementById('totalTransactions');
            const avgTransactionEl = document.getElementById('avgTransaction');
            const totalItemsEl = document.getElementById('totalItems');
            
            if (totalRevenueEl) totalRevenueEl.textContent = formatCurrency(totalRevenue);
            if (totalTransactionsEl) totalTransactionsEl.textContent = totalTransactions.toLocaleString();
            if (avgTransactionEl) avgTransactionEl.textContent = formatCurrency(avgTransaction);
            if (totalItemsEl) totalItemsEl.textContent = totalItems.toLocaleString();
            
            // Update revenue change indicator
            const revenueChangeEl = document.getElementById('revenueChange');
            if (revenueChangeEl) {
                if (monthlyRevenue > 0) {
                    revenueChangeEl.className = 'stat-change positive';
                    revenueChangeEl.innerHTML = '<i class="fas fa-arrow-up"></i> This month';
                } else {
                    revenueChangeEl.className = 'stat-change neutral';
                    revenueChangeEl.innerHTML = '<i class="fas fa-minus"></i> No sales yet';
                }
            }
            
            // Update transactions change indicator
            const transactionsChangeEl = document.getElementById('transactionsChange');
            if (transactionsChangeEl) {
                if (totalTransactions > 0) {
                    transactionsChangeEl.className = 'stat-change positive';
                    transactionsChangeEl.innerHTML = '<i class="fas fa-check"></i> All time';
                } else {
                    transactionsChangeEl.className = 'stat-change neutral';
                    transactionsChangeEl.innerHTML = '<i class="fas fa-minus"></i> No data';
                }
            }
            
            // Update alerts
            const criticalAlert = document.querySelector('.alert-danger div');
            if (criticalAlert) {
                criticalAlert.innerHTML = '<strong>Critical Stock:</strong> ' + outOfStock + ' items are out of stock across all stores';
            }
            
            const warningAlert = document.querySelector('.alert-warning div');
            if (warningAlert) {
                warningAlert.innerHTML = '<strong>Low Stock:</strong> ' + lowStock + ' items are below minimum threshold';
            }
            
            const infoAlert = document.querySelector('.alert-info div');
            if (infoAlert) {
                infoAlert.innerHTML = '<strong>Info:</strong> ' + products.length + ' total products in inventory';
            }
            
            // Update recent transactions table
            updateRecentTransactions(sales);
            
            // Update top products
            updateTopProducts(sales);
        }

        function viewAllTransactions() {
            showNotification('All Transactions', 'Loading transaction history...', 'info');
        }

        function editProduct(id) {
            const product = products.find(p => p.id === id);
            if (product) {
                editingProduct = product;
                
                // Pre-fill the form
                document.getElementById('newProductName').value = product.name || '';
                document.getElementById('newProductSKU').value = product.sku || '';
                document.getElementById('newProductCategory').value = product.category || '';
                document.getElementById('newProductMRP').value = product.mrp || '';
                document.getElementById('newProductCostPrice').value = product.costPrice || '';
                document.getElementById('newProductSellingPrice').value = product.price || '';
                document.getElementById('newProductStock').value = product.stock || '';
                document.getElementById('newProductStore').value = product.store || '';
                
                // Change modal title and button
                document.querySelector('#addProductModal .modal-title').textContent = 'Edit Product';
                document.querySelector('#addProductModal .btn-primary').textContent = 'Update Product';
                
                openModal('addProductModal');
            }
        }

        function viewCustomer(id) {
            const customer = customers.find(c => c.id === id);
            if (customer) {
                showNotification('Customer Details', `Viewing ${customer.name}'s profile`, 'info');
            }
        }

        function exportData() {
            showNotification('Export Started', 'Preparing data export...', 'info');
            setTimeout(() => {
                const data = { products, customers, timestamp: new Date().toISOString() };
                const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `retailhub-export-${new Date().toISOString().split('T')[0]}.json`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                showNotification('Export Complete', 'Data exported successfully', 'success');
            }, 2000);
        }

        function generateReport() {
            showNotification('Generating Report', 'Creating sales report...', 'info');
            setTimeout(() => {
                showNotification('Report Ready', 'Sales report generated successfully', 'success');
            }, 3000);
        }

        // ===== GLOBAL ERROR HANDLING =====
        window.addEventListener('unhandledrejection', (event) => {
            console.error('Unhandled promise rejection:', event.reason);
            // Prevent the default behavior (logging to console)
            event.preventDefault();
        });
        
        // ===== DOM CONTENT LOADED =====
        document.addEventListener('DOMContentLoaded', async () => {
            await initDB();
            await initializeData();
            
            await loadSettings();
            
            renderProducts();
            renderInventory();
            renderCustomers();
            loadRecentSales();
            loadDashboardStats();

            const savedTheme = (await dbGet('settings', 'theme')) || 'dark';
            document.body.setAttribute('data-theme', savedTheme);
            const themeIcon = document.querySelector('.theme-toggle i');
            if (themeIcon) {
                themeIcon.className = savedTheme === 'light' ? 'fas fa-moon' : 'fas fa-sun';
            }

            document.getElementById('reportPeriod')?.addEventListener('change', loadSalesReports);
            document.getElementById('chartType')?.addEventListener('change', loadSalesChart);
            document.getElementById('exportSalesBtn')?.addEventListener('click', exportSalesReport);
            document.getElementById('refreshSalesBtn')?.addEventListener('click', loadSalesReports);
            document.getElementById('clearAllSalesBtn')?.addEventListener('click', clearAllSales);

            document.getElementById('settingAutoPrint')?.addEventListener('change', async function() {
                await dbSet('settings', 'settingAutoPrint', this.checked ? 'true' : 'false');
            });

            document.getElementById('settingApplyTax')?.addEventListener('change', async function() {
                await dbSet('settings', 'settingApplyTax', this.checked ? 'true' : 'false');
                renderCart();
            });

            showNotification('Welcome Back', 'RetailHub is ready to use!', 'success');
        });
    </script>
</body>
</html>